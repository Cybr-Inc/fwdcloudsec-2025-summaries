# Detecting the Undetectable: Threat Hunting in Appliance Environments

**Video Link**: [Watch on YouTube](https://www.youtube.com/watch?v=1rfB0Pb0t2o)

- **Author**: Shahar Dorfman and Sagi Sadi  
- **Talk Type**: Security

## Summary

This talk presents a methodology for hunting sophisticated malware in virtual appliances using cloud-native approaches. The speakers from WIZ Research demonstrate how to leverage snapshot APIs to overcome visibility limitations in appliance environments, building file prevalence graphs to identify anomalies. They share real-world case studies where this technique uncovered previously undetected malware in PAN-OS and Ivanti EPMM appliances, including zero-day webshells and state-sponsored threat activity.

## Key Points

- Virtual appliances (Ivanti, Aviatrix, Fortinet, Citrix) are common in cloud environments with 65% of Aviatrix instances running with high IAM permissions
- 23% of known exploited CVEs in enterprise environments are found in appliances, making them high-value targets
- Traditional security tools fail in appliance environments due to restricted file system access and inability to install monitoring agents
- Cloud snapshot APIs enable forensic analysis by treating snapshots as forensic images attached to analysis systems
- File prevalence graphs identify anomalies by focusing on the "long tail" - files present on <5% of machines
- PAN-OS case study revealed multiple webshells including 4 previously undetected with zero VirusTotal hits
- Ivanti EPMM case study discovered Sliver C2 implants and various exploitation artifacts
- Analysis linked attacks across multiple appliances to state-sponsored threat actors over 2 years

## Technical Details

**Virtual Appliance Challenges:**
- Restricted SSH access and file system permissions
- Cannot install antivirus or monitoring agents
- Limited logging capabilities
- Must treat as "black boxes" for security monitoring

**Cloud-Based Solution Architecture:**
- Use volume snapshot APIs to create forensic images
- Attach snapshots to dedicated analysis systems
- Build baseline histograms of file paths and hashes
- Compare across multiple instances to identify deviations

**Threat Hunting Methodology:**
1. Select target appliance technology (prioritize vulnerable or widely-used)
2. Collect file system data from multiple instances via snapshots
3. Build file prevalence graphs showing path/hash distribution
4. Focus on "long tail" anomalies (<5% prevalence)
5. Enrich findings with logs for attribution
6. Develop detections and IOCs for broader hunting

**Case Study Findings:**
- **PAN-OS RCE (CVE-2024-3400):** Analyzed file extensions (.php, .exe) and unique file hashes (e.g., authorized_keys) to identify compromise indicators
- **Ivanti EPMM:** Found Sliver implants, webshells, reverse shells, and MySQL dumps through large file size anomalies
- **Attribution:** Pivoted on IOCs (IPs, user agents, DNS history) to link incidents across platforms to state-sponsored actors

**Key Takeaways:**
- Appliance file systems remain largely immutable, making deviations highly suspicious
- Method scales well in cloud environments with snapshot APIs
- Applicable beyond appliances to any system with consistent file systems
- Vendor cooperation needed for better telemetry and logging capabilities

---

## Full Transcript

Good morning everyone. Apologies for the last minute scheduling snafu. Uh the next session in this track is going to be uh detecting the undetectable threat hunting and appliance uh environments. Uh before getting to that though, I'd like to thank our sponsors who make all of this possible. Uh in particular, Clear Vector, who is one of our bronze sponsors. If you'd like to learn more about them, definitely go check out the booth uh that they have in the vendor hall. Um the following talk will be provided by Shahar Dorfman and Sagi Sadi and I believe they will be joining us remotely if we can patch them in. Okay. So thank you everyone for attending our session. It's called detecting the undetectable threat hunting in appliance environments. And in this session we are going to present to you the methodology that we internally use in order to hunt sophisticated malware instances in virtual appliances. We'll also explain how we used features unique to the cloud to create a file prevalence graph and why focusing on the long tail on the graph that you see on screen was extremely effective for for threat hunting. But before we begin, let's do a quick introduction. My name is Sagit Sadik. I work as a security researcher for the WHI research team. And hi everyone, I'm Shakra Dorfman. I'm also a threat researcher at WHIS. So in terms of what we are going to cover today, first we'll talk about the virtual appliance landscape. We'll do a quick introduction to virtual appliances and examine their presence in the cloud. Then we'll talk about challenges in threat hunting in virtual appliances and how the cloud can actually help us do this job better. Then we'll dive into two real world examples where we actually use the methodology uh we present to you today to find previously undetected malware instances uh in the environments that we monitor. And we'll finish with some conclusions and final thoughts. So what are virtual appliances? Virtual appliance is a preconfigured software application that includes all of its components and essentially the vendor uh chooses the operating system, the application and the dependencies for you. Now, uh virtual appliances are typically dedicated to a specific task. So, you'll have virtual appliances for security purposes, for user management, for networking. And to put things simply, uh their setup is really simple, but it comes at the cost of flexibility. So you often have to treat virtual appliances some sort of a black box. Um their file system is immutable to you because you don't often get root access to them and it's really difficult to install monitoring tools on them. Now I've been saying virtual appliances quite a lot to this point. So let's look at some examples. So whenever I'm saying a virtual appliance, I mean one of these products, Ivanti, Aviatric, uh, Forinet, Sigma, essentially any of these software solutions that you have to embed in your environment as is. So let's talk about some security challenges in virtual appliances. First of all, it's really important to establish that uh virtual appliances are quite common in cloud environments and that they are often exposed to the internet. Now our research actually found that they are occasionally running with high IM permissions. For instance, 65% of the Aviatric instances that we monitor are granted high IM permissions in AWS environments. Now, as I mentioned previously, uh you often have to treat them as some sort of a black box, meaning that you lack visibility and that it's hard to monitor um these devices. And for all of these reasons, um, virtual appliances had had become a very high value target for attackers. In fact, 23% of all known CVs of all known exploited CVS in Enterprise Revolvent were found in an appliance. Now, as you can see on screen, during the past couple of years, there have been many incidents where a critical remote code execution vulnerability was discovered in a virtual appliance which quickly became exploited in the wild by attackers. And with that, I'd like now to invite Shah to talk about the visibility problem of virtual appliances. Thank you, Sagi. So, the biggest challenge in virtual appliance environments we would like to address today is the visibility problem. Many appliances restrict access to their file system even for legitimate admins. This means that you as the admin of the machine can manage file on the machine and can't upload your own custom file to the machine. In addition, you can't install tools or agents that you typically use for telemetry collection and detection of malicious activity. You can see here an example from Ivanti's documentation stating that the installation of antiviruses on the Ivanti appliance is restricted. When it comes to login, while some appliances do save access log to the machine, in many cases those logs file are minimal and they are usually hard to find. All of this makes it incredibly difficult to investigate suspicious activity on a virtual appliance. And that raises the question we would like to answer today, which is how do you investigate what you cannot see? Okay. So, when we're investigating a potential attacker running a malicious call on on a generally any virtual machine, we typically need two key types of information. First, we want meta data about the VM itself like the instance name, AMI version, IM context and tags related to this machine. Second, we need host level data like what processes are running on this machine, how does the file systems look like, uh which versions are are of software are installed and whether any secrets are exposed on the disk. As we said before in virtual appliances we have the visibility problem making it hard to monitor or research this kind of information in the cloud. However we do have APIs that provide us some metadata uh about the machine uh which is useful but as we all know this metadata alone is not enough to properly investigate an incident or understand what happened on the machine. So our solution to this is using the snapshot API. You just find the relevant volume you want to investigate. Then you create a snapshot out of it and attach it to an analysis system. Essentially treating it like a forensic image. Then you can run your rules, inest logs, and find anything you wanted before but didn't have. For example, you can find misconfigurations uh or non vulnerabilities exposed on the machine, secrets that were left on disk, malware uh which OS is installed on the machine and gen generally how does the file system looks like. Okay, so this snapshot method that is probably familiar to many of you isn't just valuable in virtual appliance environments, but it can be useful for any virtual machine uh investigation, but it works especially well in virtual appliances. That's because SSH access to those devices is usually restricted or minimal, and admins, as we said before, usually don't upload their own custom files to the machine. So most files remain identical across deployments. This means that any deviation or any unexpected change in the file system really stands out and that's exactly what we try to leverage. Okay. So before we'll dive into some real world case studies, we wanted to go over our virtual appliance threat research life cycle. So first we start by selecting a specific appliance technology that we want to investigate. We usually choose something that is widely used or that is known to be vulnerable. Then we collect files from different machine and different environments running this specific appliance technology. Using those files we can we can build histograms of path and hashes and essentially build some kind of a baseline of how does the file system of this specific appliance should look like. Using this uh baseline we can start looking for anomalies for what we call the long tail essentially uh path that are present on small percentage of the machine running this specific appliance. Once we find those suspected file we can enrich the information with logs finding out who deployed the file when did it happen and how did it do it. uh this can helps us find malware and exploitations of known and previously unknown vulnerabilities which it this is our prime goal in any research actually. Okay. So once we have this we can uh develop detections and ingest IOC's in order to uncover similar activities in different environments. Okay. So now that we've walked you through the process, let's take a look at how this played out in the real world. Okay. So let's get started with our first case study of the day which talks about remote code execution vulnerabilities in Panos. So for anyone who's not familiar with Panos, essentially it's the proprietary operating system that is developed by Palo Alto Networks in order to power their security products and in somewhere at the end of 2024 there were found two vulnerabilities that when combined together could be exploited to an unauthenticated remote code execution. Now, as you can see on screen, they quickly became exploited in the wild by attackers. Now, as Shah mentioned previously, since Pan OS is an appliance, this means that we can work under the assumption that the file system is pretty much immutable as you don't often get root access to the to the machine. And this means that the file system between two different Panos instances should be pretty much identical besides logs and configuration files. And this enables us to ask the question are there any file present on the file system with an interesting extension s such as PHP XE etc. And if there are and they are only present on some of the machines that we monitor this could be an indication of compromise. Another interesting question that we can ask is are there any common files with a unique hash? So let's take for example the authorized keys file. This file is going to be present on all of the machines that we monitor. But if only on one machine it has a unique hash to it. This means that someone tried to intervene with this file and maybe tried to backdraw the machine by editing this file. So this could be an indication of compromise as well. Now, of course, there are other file system related metadata that we can use such as file size, modification time, extended attributes, etc. So, we analyzed all of the Panos machines that we monitor and we came up with the following graph. So, here you can see on the x-axis the file path and on the y-axis is how prevalent is this file among the panor machines that we monitor. So we can dissect this fi this graph into a couple of groups. The first group would be files that are present on all of the machines that we monitor. Uh we call these the stock files meaning files that come with every panos. These are legitimate files and they're not suspicious. Then we have files that come with most of the uh instances. So between 90 and 100%. Um this could be explain explained due to version variations. uh meaning that at some versions this file used to exist on a certain path and in other versions the the same file exists on a different path. Then we have the group of files that exist only on some portions of the machines that we monitor. So between 10 and 70% uh this could be explained due to uh plugins or popular add-ons. But the most interesting group here is the uh group at the long tail um files that are only present on 5% of the machines or less. And this is where we suspect to find malware. So let's focus on this uh long tail of the graph on this group and see what we can find. So if we look at the files with low prevalence, we can see that as we initially suspected, most of them are in fact uh malware instances specifically of the web shell type. So uh let's let's have a look on the uh findings of this case. So uh by using this methodology, we managed to find numerous malware instances with four of them being previously undetected, meaning that they had zero hits on V total, which is pretty cool. And as you can see on screen um most of them are web shells. Now in terms of next steps we are really interested in understanding who are the attackers behind this attack and we can start working towards answering this question by ingesting the log files from the compromised machines and start creating IoC's for the attacker uh based on them. So we can track the IP addresses that the attackers use. Um the user agent uh perhaps they made some very unique browsing sequences that we can track and we can use these IOC's in order to search for the same attackers across different environments that we monitor. Another interesting question is are there any targets targeted by the same attackers? And we can work towards answering this question by creating YAR rules for the new malware instances that we found and start hunting uh using those YAR rules on different environments that we monitor and perhaps we'll find cases where the same attacker exploited a different vulnerability to install a similar implant. Okay, great. So the second case study we'll talk about is the Ivanti endpoint mobile manager appliance. So the Ivante EPMM is a software designed to help organization manage and secure mobile devices, applications and their access to the network. Just a couple of months ago, two vulnerabilities were found on the Ivante EPMM appliance. Those vulnerabilities when chained together allow an attacker unauthenticated remote code execution on the Ivante device and from this device potentially to other devices in the network. Only 3 days after the publication, a PC was published as well and that was when we and other vendors started seeing exploitations of those vulnerabilities in the wild. Since the Ivanti EPMM is also an appliance, we apply the same technique here as well. In this case, we looked for the long tail where Shawan hashes that were linked to relatively large file sizes. So looking at file that were present present on small percentage of the machine, it's easy to spot the files that have relatively large file size, those three files. Looking at those files and examined them, we found out the two of them were actually sliver implants. So to anyone who is not familiar, sli sliver is an open-source command and control framework written in go. It's used for red teaming but it's also being abused by threat actors as an alternative to tools like cobalt strike. Okay. So other than the sliver implants, we found several exploitations resulting in web shell deployments, reverse shell, MySQL dumps and others. So as mentioned before, appliances are high value targets and we've observed exploitations of them by both opportunistic attackers and nation state threats. So we really wanted to find h out who stands behind the the activities in the panos incidents and the incidents. In this case, when we pivoted on mutual IOC's and researching malware and pivoted on DNS history, we managed to find what seems to be state sponsored threat actor that stands behind both the Panos incident and the Ivanti incident as well as behind several other incidents that were resulted in exploitation on of virtual appliances in the past 2 years. So it's really really interesting. And now that the actor is uncovered, let's move on to some final thoughts. Okay, first as we shown today, even where even where traditional security tools struggle like virtual appliance environment, we can still find new and creative ways to get access to the machine and provide visibility. The cloud actually also makes this process pretty uh scalable and more effective. We also talked about how virtual appliances are important part of cloud environments. In many cases, appliances have high permissions and access to sensitive data. They're also often not protected by regular security tools and sometimes people forget to monitor monitor or update them. That's why attackers focus on them and that's why we need better ways to detect and protect them. Having said that, we can't do it alone. Working with appliance vendors to expose more telemetry logging and more lo and more logging options is crucial. To end on a hopeful note, this method isn't uh just limited to virtual appliances. We chose them because they're often hard to investigate and tend to have similar file systems. across deployments. However, we believe this approach can be adapted to other cloud systems as well with just a few adjustment depending on the software. Hopefully, this technique will help improve visibility across many areas of the cloud. Okay, thank you everyone for listening and if you have any questions, please don't hesitate to reach out. Thank you so much. We'll be uh taking questions in the room. If you have any, please uh raise your hand and I will bring this microphone over to you. Uh hopefully they're not too spread out across the room. Any questions? Is there a way that customers who have these kind of appliances can do the same kind of file uh prevailance checking that you guys did to see if there's web shells in our environment? Like it is there are you going to publish how you did it and how we can do it? Um okay so uh in order to create the graph that we showed on screen uh this was done by taking a snapshot of the relevant appliance and simply listing all of the files in the snapshot uh because uh we monitor a lot of uh environments and we have and we can see a lot of instances of the same appliance. It's much easier for us in order to create a file prevalence graph. Um but if you have multiple instances of the same appliance in your environment, uh you can apply this technique. Um or you can have it or you can install like a stock version of the appliance and make uh like differences and see differences between the stock version and uh your production version of it. Um so I guess uh I hope this helps. Yeah. Uh we also had some questions on Slack. Um first does the snapshot option always work or do some vendors have virtual appliance uh with encrypted discs with their own keys? Yeah, some some uh appliances do have encrypted discs and then this this method of the snapshot will will not work actually. H and I will also refer to the last question. Uh we also think that if the v working with vendors that uh produce this appliance if they will publish like the file path that are supposed to be on the appliance or hashes of those files. So maybe we can build like some kind of of this uh baseline without have needing to have so many machines in the environment. So this is another option but it's not realistic for now. Great. Um, another question on Slack. Uh, does the snapshot approach also work for in-memory or fileless fileless malware forensics? Um, so no, it will not work uh for files or inmemory uh implants in most circumstances. Yeah. Uh, another question, uh, what kind of response did you get from the vendors? Are they thinking about allowing customers to have more access? Oh. Did do we lose you on audio? Can you hear us now? No. Yeah, we can hear you. Okay. Sorry. We actually didn't have we didn't approach vendors yet, so but we'll planning on doing so. Okay, no worries. Makes sense. Uh, any other questions in the room? All right. Can we all get a round of applause for our wonderful speakers? Thank you. Thank you. Thank you.