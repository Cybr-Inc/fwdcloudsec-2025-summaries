# Defenders hate it! Compromise vulnerable SaaS applications with this one weird trick

**Video Link**: [Watch on YouTube](https://www.youtube.com/watch?v=rQxc9N4gBqA)

- **Author**: Eric Woodruff
- **Talk Type**: Attack Techniques & Vulnerabilities

## Summary

This talk exposes the ongoing NAUTH vulnerability in SaaS applications using OpenID Connect with Entra ID authentication. Eric Woodruff demonstrates how attackers can impersonate any user in vulnerable applications by simply knowing their email address, exploiting applications that use mutable email claims instead of immutable identifiers for user authentication. Despite being disclosed in 2023 and supposedly "fixed" by Microsoft, the vulnerability persists in many applications today, with 8.6% of tested applications still vulnerable. The attack bypasses all traditional security controls and is extremely difficult to detect.

## Key Points

- NAUTH vulnerability allows account takeover of any user in vulnerable SaaS applications using only their email address
- Originally disclosed by Omar Cohen of DCOPE in June 2023, but the vulnerability still exists today in many applications
- Microsoft's "fix" only applies to new app registrations created after June 2023 - older applications remain vulnerable
- Attackers can set unverified email addresses in Entra ID using simple Graph API patch operations
- The attack works by exploiting applications that use mutable email claims instead of immutable identifiers (subject, issuer, OID)
- Research found 9 out of 104 tested applications (8.6%) in the Entra Gallery were vulnerable
- Vulnerable applications included HR platforms, knowledge sharing systems, and apps with Office 365 integrations
- The attack bypasses all tenant-level security controls (MFA, Conditional Access, CASB solutions)
- Detection is extremely difficult as the attack happens "out of band" from the victim's tenant
- Most application vendors showed little concern when notified, with some taking months to respond or not responding at all

## Technical Details

- **Attack Flow:**
  1. Attacker creates malicious Entra tenant with user account
  2. Attacker sets unverified email address to victim's email using Graph API
  3. Attacker authenticates to vulnerable SaaS application using "Sign in with Microsoft"
  4. Application only checks email claim (mutable) instead of subject/issuer (immutable)
  5. Attacker gains access as the victim user with full privileges

- **Vulnerable Application Characteristics:**
  - Uses OpenID Connect with Entra ID authentication
  - Relies on email claim for user identification instead of subject/issuer
  - Created before June 2023 OR has "removeUnverifiedEmailClaim" set to false
  - Lacks proper account merge logic or email ownership verification

- **Microsoft's Mitigation (Limited Effectiveness):**
  - New app registrations after June 2023 have "removeUnverifiedEmailClaim" set to true by default
  - Developers can still manually set this to false to consume unverified email claims
  - Verified vs unverified domain concept exists but many domains remain unverified
  - No visibility for customers to know if their SaaS apps are vulnerable

- **Detection Challenges:**
  - Attack occurs entirely in attacker's tenant, bypassing victim tenant security controls
  - No correlation possible between victim tenant sign-in logs and SaaS application logs
  - SSPM tools won't detect this type of vulnerability
  - Browser security extensions can't identify the issue

- **Research Findings:**
  - 9 vulnerable applications out of 104 tested (8.6% vulnerability rate)
  - Vulnerable apps included: HR platform, absence management, knowledge sharing platforms, business coaching platform, construction site management, meeting scheduling with O365 integration
  - Applications with Office 365 integrations pose additional risk as they become pivot points into victim's email/calendar

- **Vendor Response Issues:**
  - Most vendors difficult to contact for security issues
  - Varied response times from 1 week to ongoing (6+ months)
  - Some vendors removed Entra integration entirely rather than fix the issue
  - Some implemented paywalls to prevent further testing
  - Poor understanding of the vulnerability among development teams

## Full Transcript

Everyone welcome Eric, please. Thank you. All right. So, uh yeah, we'll just get into things here. Um have a lot to cover. Uh depending on how much time we have left at the end, uh maybe we'll sort of see uh video of this actually being done uh in the wild here. Um but again, introduction. So, I'm Eric Woodruff. I'm currently chief identity architect at Seus. We do active directory uh in ID security stuff. If you're wondering what that title means, uh I do as well. um social media handles there, you know, not cool hackery things, but feel free to uh hit me up about this or anything else. Um and yeah, we'll just get right into it. So, right on the backstory here uh for what we're going to be talking about today. Um right, is no, right? And so, this was disclosed by Omar Cohen of Dcope on June 20th, 2023. Uh and in their research they talked about how it was around April 2023 that they reported this to Microsoft um right it's a vulnerability this out of my way um in apps using open ID connect uh to uh you know integrate with enter ID for authentication right um the vulnerability is rooted essentially in an anti-attern for implementations of open ID connect um and it allows an application or the vulnerable application allows for takeover write impersonation however you want to put it of uh any user in that application just if you know their email address, right? So uh if the app is vulnerable to it, I know their email, I can get in as this person. Um and Dcope at the time basically, you know, classified this as a sort of cross identity provider uh attack. So you know, we we'll kind of be hopping back and forth to a timeline here, right? So you know, so far what we know is June 20th this was de uh disclosed and then we have today, right? and sort of like who cares, right? This is now a two plus year old vulnerability. Um but you know I think there's some interesting things going on here uh unfortunately with uh no right. So uh when this was published MSRC uh put out this blog article on risk of privilege uh escalation and Azure AD applications um right and within this I thought this was interesting uh this customer impact piece of things and actually I really need reading glasses here. The only the only slide I'm going to read to folks, but I got to look at this monitor so I can see. Um, right is Microsoft has identified several multi-tenant apps with users that use an email address with an unverified domain owner. Although unverified email addresses do not pose a risk to applications that don't utilize the claim for authorization purposes and the underlying part, right? These application owners have been notified and provided with guidance on how to modify their applications if applicable. Right? So the the TLDDR here is that you know Microsoft sort of looked at applications and if they believed an app was using this email claim right they notified uh you know the owner of the app on how to remediate things. Um again underlined right if you did not receive a notification your application has not consumed email claims with unverified domain owners. So again right they're basically saying uh if we didn't notify you then you don't need to worry about anything. uh my interpretation, right? And then they have some, you know, protect customers and applications that may be vulnerable. There's some mitigations in place and we'll kind of dive into those mitigations a bit down the road here. So, you know, when this came out also uh it was interesting because if you looked at a lot of the news that uh you know was out there when Dope published this, right? So, we have the hacker news here uh and then bleeping computer, right? So, hacker news critical knoweth law and Azure AD enabled, right? sort of past tense, uh, complete account takeover, bleeping computer, right? Microsoft fixes Azure AD off law enabling account takeover. Uh, you know, again, Petri, right? Microsoft, you know, patches critical no flaw on Asia Azure AD apps. Uh, but you could go read all this and sort of just presume like, well, hey, right, it was a Microsoft problem and now Microsoft's done a Microsoft fix and we can all just sort of move on with our lives. Um, and actually I completely forgot about this when I was researching that in 2023 I I wrote a blog article that probably very few people read where I was actually complaining about the uh the reporting um on no off because it wasn't actually you know a patch or a a fix right so again our timeline here you know what do we know so far right so effectively June 2023 that no was declared you know quote fixed here right um and I also think what was interesting from you know the uh maybe lack of attention mention that this drew in the security community is less than a month later we had the storm0558 incident which if folks are familiar those that aren't right this is where Microsoft uh signing keys were stolen and it was this whole big thing right trying to figure out what was compromised you know how to happen and that really overshadowed I think a lot of other you know security incidents that could have been going on in the the Microsoft ecosystem um ripping you know who cares here right this is still two plus years old um this isn't really anything that's uh re um you know mind-blowing so far. Um but unfortunately right the thing is is that NOOTH is something that still exists today right so um you know we were starting to perform research in NOOTH and in fact you know finding that it is uh far from dead here right so the DCOE focus of things was this and we'll just kind of walk through the flow and where our our research sort of differed from theirs um right they were basically looking at you know uh these cross IDP attacks so a legitimate user you know is authenticating with Google maybe they're a Google works space shop, right? Um an attacker configures this attack entry tenant that they use. Um the attacker authenticates uh with entry using that unverified email attribute. Um and the application effectively has account merge logic flaws in it that doesn't verify email uh ownership. Right? Now the attacker is in again with this sort of cross IDP type attack. And right to sort of look at this from a different uh view here, right? If we have some SAS application and I'm a user here as Eric, you know, at fabricam.com in that application, right? And say again I have a Google account and I use that to authenticate to that app, right? Some of these apps you go to and they've got sign in with, you know, Apple and Google and Microsoft and Facebook and etc., etc., right? Um, generally when you come in and you're coming in with some other account with some other system, um, we generally have some account merge logic, right? And so what this looks like in real life and I'm using Adobe here. I don't know if Adobe was ever, you know, vulnerable during the first round of things, but they're they're not now. Just um easy examples, right? So uh the flow that they're looking at, right, is generally when you try these account merge things. I'm signing in with Microsoft for the first time. uh you go through sort of like an OTP or magic link process, right? Where you have to fill out something to basically verify you actually own that email address and then you know that we usually email you as well saying hey you know uh just to let you know we sort of combined these two accounts let us know if that's not the case. Um right but effectively their thing was finding where this logic was flawed by flawed it was usually just missing right so they would just merge accounts and then basically you know Mr. or Mrs. bad guy could just get into that account. So the research that we were doing looking at um you know the work that Dcope did a bit further here where this looks a bit different is right we have a legitimate user authenticating with Entra um the attacker configures you know that attack uh entra tenant again the attacker authenticates with entra with an unverified email attribute um and the application is not following open ID connect standards for how authentication should be implemented um and you know so effectively we're looking at this as like a cross tenant type uh attack. Um, and one thing I I wanted to just point out on here, um, is also right, I think one other thing that sort of was a failure in the the original reporting on this and also how Dcope framed it, right, is by saying it's like, you know, Microsoft accounts taking over Google accounts. Again, developers could think, well, hey, we're only using Microsoft, right? There's a lot of SAS apps out there that maybe if it's a very Microsoft, you know, centric application might only use, you know, Entra, right, as their IDP. So again, they go look at the news, look at how the the research is published, and just like, well, right, we're not using Google, so you know, who cares, right? So diving into things a bit further, um, and looking at how this all sort of functions a bit deeper. Uh, want to first level set some knowledge here, right? So we're just going to first talk about app registrations and service principles. Um, you know, a common theme, um, as as we saw in the last talk here, right, when we're talking about this sort of stuff. So uh we have our SAS application here right uh Ktoso SAS app and we have that sign in with Microsoft you know button that will be on these applications right or sign with office 365 you know whatever you want to call it right so on the developer side so Ktoso right they're the software vendor they have this app registration um you know Ktoso SAS app and then in the consuming tenant right there's going to be that service principle right and effectively the um there's a relationship between these two right so uh app registration is basically like the developer's definition of what they need and again right it's it can be saying it's a public or confidential client you know other things again like redirect URIs um and also claims right so the developer will essentially say these are the claims I want uh you know from the identity pro provider from entra uh when I'm getting that ID token right and then so our service principle effectively is the security principle and the consuming tenant and this is the thing that you know customer consents to for the application on first use and effectively enables right authentication authorization against that consuming tenant right so going back to our application right this is kind of how these things um you know tie together to that button and then right Microsoft has this sort of common endpoint system right that supports across uh you know all entra tenants right multi-tenant authentication right which is why attacks like this wouldn't happen against something like octar or whatnot right so we have common endpoints out there that enable multi-tenant apps, right? And again, you know, there's an authorization endpoint and token endpoints that are used for different things and we're not going to get into that, right? But it's important to point out here that, you know, that common endpoint is a thing that is what really enables this, right? Microsoft has sort of uh engineered or architected themselves into this corner uh when we start talking about no, right? So if we're following the open id connect spec uh here we have you know user eric at fabricam.com at the consuming tenant right and goes to the application and hits you know signin with microsoft right and it might be a little hard to see on here but you don't really need to read all this right but we effectively get that ID token from entra right and our SAS applications are going to have some you know user database user table on the back end right and effectively in that we're going to capture different attribute data about that user um and the thing is we want to make sure that we're you know looking for subject or issuer or sometimes maybe um you know oid here right but effectively these are unique immutable identifiers right the issuer is the tenant ID for the entr tenenant which is always going to be globally unique and the subject is a pair-wise identifier that's you know basically some sort of hash combination of the user's object ID the application ID and the tenant ID right so you can be sure that if you see this subject coming in in an ID token you always know this is that user um and from from an entry perspective, right? This is immutable. There's no way that you can modify or manipulate the subject claim, right? So in our no vulnerable applications, right? I mean, it's going to look similar from an enduser perspective. Uh here we're basically going and hit and sign with Microsoft. You know, the application still gets that ID token here, right? We still have our, you know, user table on the back end of our SAS app. Um but the problem is here right that well we're only focused on you know basically things that are mutable identifiers like email address right now a developer might think well hey you know conceptually right email addresses are unique but not thinking of the fact that potentially an ID token right may be coming in with one where that email address is in fact mutable data right from the identity provider here. So right we can abuse this effectively now because we have you know our evil tenant here and we have our evil user right where we can see that my UPN here is eric evil.cloud cloud, but I can go spoof my email address to ericfabricam.com, right? I go hit sign in with Microsoft. I send this ID token up to, you know, the SAS application, right? Now, the subject issuer, all that sort of stuff is going to differ in this. But if my application is only looking at email address, right? I'm effectively in as this end user, right? Now, I have access to everything that they have access to. Um, right? So, setting an unverified email address is super simple here. And we'll just walk through a very quick uh video of this. Maybe I can get off my ink. So, we can see here that um right basically here we got a user Kenny Rogers. And we'll scroll down a little bit here and see the mail address Kenny. blah blah blah on Microsoft.com. And we're just going to run a very simple patch operation here. Right? So we're going to go basically just update the mail address. Right? This is using graph explorer. There's 100 different ways we can do this. So we patch a user. We don't get an error and we just, you know, do another get on Kenny. And now we can see that we're, you know, effectively saying that we're Alex Wilbur at Fabricam, right? And we could then go in as Alex Wilbur into whatever application is uh vulnerable here. All right. So, you know, there's also other methods for setting unverified email address, right? And again, the initial uh Dcope research was really just looking at that one method that we just looked at, but you can also convert guest invites uh to members um and hybrid users, right? So, if it's a hybrid environment with Active Directory, uh if the mail address is set to something in Active Directory that's not verified, that's going to flow up to um you know, Entra as well. I mean in the reality right most attackers would probably go through that first path because it wouldn't make sense to sort of go compromise someone's active directory to then use that tenant to you know pivot into some other tenant. Um but just pointing out that there are other ways to uh sort of set this unverified email address right so also if we want to examine claims uh we can easily look at this right so kind of trying to understand how this works um you know a bit easier with a jot right so if we go to this diagram and we want to basically you know look at that ID token right we can actually go out here um and configure an app registration and redirect our ID token to jotms right now I I I was trying to re-record this demo when I was on the road over the weekend. Uh had some lab difficulties. So, apologies if it's a bit uh small here. Right. So, we're going to see here that we're actually signing into our application as our valid user, right? And once we uh you know, off here to work on my video editing skills a little bit. And we can see here that right here's Alex Wilbur with Alex's uh you know email claim here. Right? But Alex is that user. So there's no issue. But now we're going to go in as right the attacker user here where we've already gone through and you know adjusted the email claim uh in Entra right and we're going to this application that would be you know quote effectively uh you know vulnerable to no off you know authenticate right and so again it might be hard to read especially in the back but if we look here right this other user um you know coming in also has Alex's email claim uh set on the account right and so you know easy way to sort sort of see how this you know conceptually removing an application uh would happen. So you know if we're talking about uh you know the abuse here right Microsoft implemented as uh they mentioned some mitigating controls here right so um you know there is a concept of verified and unverified domains right so if you're on boarding an entry tenant uh for you know consumption purposes or usually right if you're using Microsoft 365 you go through some process where you say uh you know hey like we want to use this for email for exchange and all that stuff right and you verify your domain name either with a you know text or MX records sort of check here, right? So, we can say whether a domain is verified or unverified. Um, right, in app registrations that have been created after June 2023, right? When this research was published, uh, basically say that the remove unverified email claim, this attribute on the app registration is true by default, right? So, new app registrations inherently wouldn't be vulnerable to this. But, you know, how many applications existed before June 2023, right? a lot of them. Um, but there's also bypasses on this sort of stuff, right? So, the developer can set this claim uh to false. So, they can just so flip a bit on this and basically say, "No, I want to consume unverified email claims." And they might find that they have legitimate purposes to do this. Um, and again, right, applications created before June 2023 and are using that email claim. So, you know, when we're getting into trying to find applications to research for, you know, potential vulnerability to no, we actually were looking at the entry gallery. And so, in the entry gallery, uh, it's this sort of dumpster that exists, um, for easy integration of applications with entry ID. Um, and you can come out to this thing and basically just filter by open ID connect, right? And basically get all the applications that are multi-tenant, right? Um but these are the only ones that you know ISVS they ask to get put into this right so this is only a fraction of all the applications out there that are multi-tenant right vendors basically have to apply to get put in this this gallery here um but in this right so we at the time had you know 17 open ID connect applications in here um and we tested 104 of these right so basically we were trying to find apps that had some sort of you know self-service signup signin sort of stuff going on uh trials that didn't require require you to basically talk to a salesperson or something like that, right? Because we're just trying to test the water here to see um what the landscape of vulnerability looks like for this, right? And this is where we found uh nine applications that were uh vulnerable within here. And you know, you may look at this and say, well, that's like sort of a drop in the bucket, right? But if we look at it a different way here, right? That's 8.6%. So if we're generous and round up to nine, right, out of our testing, uh that we're vulnerable. So, you know, in this one of the things I've been asked a lot is like, well, how many applications, right, do you think are actually vulnerable out there, right? And you we we don't really know, right? Um, nobody really can tell how many are vulnerable, right? I'd say it's probably more than 10. I don't think I found, you know, 90% of all applications that were vulnerable to this. Um, you know, Microsoft should, and I I believe they do know, right, how many applications are consuming this email claim. Um but un unfortunately right the consumption doesn't mean they're vulnerable. Again app developers could be using that claim because they want to send an email to someone right um unfortunately unless you actually have eyes into the SAS app you have no idea what the application is doing with that ID token once it receives it. Right? So you know with this though uh you know back to our timeline here. So December 3rd 2024 open a case with MSRC on our findings. Um, you know, both because we're like, hey, you have this stuff in the entry gallery. Customers could potentially think that this stuff has been, you know, vetted better than stuff that's not in it. Um, also, you know, you sort of made it sound like you worked with the developers to fix these problems a couple years ago, right? Uh, kind of what's up with the findings here and right as far as the applications that we found, right? So, of these nine, right, there was a a human resources platform, right, which was the thing that was really most concerning here. Now, it wasn't like a big workday level one, but nonetheless, right? Uh it would have been chalk full of PII. Uh again, the concern is it would take a trivial amount of work to go figure out who the HR administrators are potentially of, you know, customers of their platform and then pivot in as those users, right? And get access to basically all the the employee data in there. Um there was also a absence management system uh that I won't have more details on yet because it's still vulnerable. uh that also had a lot of PII sort of stuff within it. Um three knowledge sharing platforms, collaboration platforms, right? Which you know inherently you might say like so what but they felt like those sorts of systems, right? That potentially you know security teams could keep you know architectural diagrams and all this other sort of stuff about environments in um you know some other platform out there that again is still not resolved that they claim to have 45,000 plus customers. uh a business coaching platform and this is where it also gets interesting that had Office 365 integrations. There's some construction site management platform and a meeting scheduling platform with 0365 integration, right? So think of like a Calendarly type thing. And the 0365 ones also were a bit concerning because effectively you could use a SAS application, right, to then go pivot into these people's mail accounts, right? You'd get access to their calendar. Some of them could send mail, read, you know, calendar data, send invites, um, read email, stuff like that, right? So, there's also that concern that the SAS app now is a new pivot point, right, into their Office 365 environment. Um, and you know, interestingly here, uh, we'll we'll sort of talk about the application vendor response. So, uh, December 2nd, right, we started notifying the application vendors basically the day before we opened our case with MSRC. Um and this is basically what you know most app vendors sort of response was like um if we even got one from them. So uh right with the application vendors the quicks was one um within one week uh one resolved the issues. We worked with them pretty uh closely to uh get that taken care of. Um and as you can see right again the longest on is is still ones that are ongoing. Right. um two weeks before sort of putting this together uh you know testing these applications as we'd occasionally do found that these two were still vulnerable um you know and interestingly in sort of taking some digs at at vendors here right and there their sort of lack of concern around this stuff right um is it was varying in how easy or not easy it was to report these problems right so you go to the vendor site uh you try to find you know their privacy policy or some stuff about all their sock 2 compliance and all that and you're like all right somewhere there's got to be like a privacy or a security email address or something like that or you just guess right if you don't find anything or you find their you know ticketing system and you open a ticket and you're like hey I found this sort of vulnerability um but it was a bit all over the place some we resulted to go into like LinkedIn and trying to see who you know their their CISO or their data protection officer or whatnot was um and and also right variation in the vendor response so uh with the MSRC case Microsoft also started started contacting some of these vendors. Um, and while I won't really speak on on their behalf, um, it seems like some basically could care less that you're trying to, you know, warn them of a problem, right? And initially because you're not sure who you should talk to, right, we didn't want to disclose all the details of some sort of random email address, but as you're going through, right, you sort of are more specific like, hey, like here's this problem, right? And you sort of get um, no response or the we'll look at it, right? And I don't know how many months it takes to look at something like this. But um you know the other thing that is a bit interesting is you know some just actually removed their integrant integration. So I'm assuming they just like couldn't figure out the problem and it wasn't worth it to them. Um and some actually put up pay walls that prohibited testing. So, uh, again, just an interesting sort of thing here where when we went to go retest a few of these sometime around April, May, uh, a couple of them now that were sort of like, you know, free trials basically required you to put in a credit card or something like that or, you know, contact their their sales department. And again, it made me wonder, did they actually fix the issue or are they just putting up some other way to prevent you from actually uh testing this thing? Um and also the the case I had with MSRC and here it's a grudge time with Microsoft. So uh basically right this is what the the case was like uh when I was working with uh them or or I guess not working with them so much. Um right so the MSRC case uh as mentioned right December 3rd opened this case with MSRC. Um December 4th right the day later this case was acknowledged by u MSRC. Um again we we had that one organization that was pretty quick to update things. So we wanted Microsoft to know like hey this one we reported that's vulnerable is no longer vulnerable in case they were also reaching out to the vendors. Um you know so sometime in December I was awarded 60 points and I'm like okay cool. Like generally if you're in the Microsoft research world you know if you get points that must mean like they care about the problem right? So I'm like well that that's good right? And it seems like it's uh moving along or whatnot. Um, and then then the silence starts. So, uh, eventually March 17th, right? So, given them enough time, they're off doing their zero day quest or whatever it was, fun stuff, right? Um, asked them about actual cases that are open and what the status is. Um, and also, uh, you know, March 18th, now I tried, um, color coding this and now realized I made a mistake because the red was supposed to be me reaching out to them. Um, so March 18th, I also notified them that I was going to be speaking about this sort of stuff, right? Um, and then interestingly, a day later, I lose my points. So, I'm like, "Okay, well, they obviously are paying attention to me, right? Cuz I lost them pretty quick, but I haven't received any any response back." Um, and so I asked them about the point loss, right? I'm like, "Hey, you know, again, just like trying to figure out what's going on." And you know, I'd say in particular, right, because this was a thing that I thought was complex because this is an already disclosed vulnerability, but we feel like we have strong enough findings to open a case. We're not looking to necessarily write go sort of dump on Microsoft here without um talking to them first, right? So, it was a very frustrating process because we're trying to work the system the way they want, right? And they're just sort of silent here. Um and then a month later they close the case with these sort of like uh some sort of problem has been um you know the problem you report is fixed uh we'll put you on like the wall thanking you right so in the whole thing here you know no response at all from them actually with any details of you know what they thought any of my questions none of it was answered um so then the end of April after I started uh being less frustrated with them I contacted MSRC listens which they started to engage with me on but still even this Right. Uh I have not heard anything um you know recently, but where it got a little interesting was uh right because I also was speaking at troopers about this uh last week um that as we're getting closer to disclosure time, all of a sudden you start to get that like oh like maybe they're thinking this isn't going to look so great, right? So at the end of June or well June 20th, so the Friday before losing track of time with the travel, right? Very recent, right? had some conversations with MSRC, but unfortunately, right, this still was not through the official channels here, right? So, again, there's still some frustration with the case. Um, but some of the information that, you know, we've talked about in here was sort of like things that I was allowed to uh, you know, talk about, right? And one thing that we have in the blog which I'll I'll have up in a a minute here was um basically MSRC said that the applications that aren't resolving themselves right or if people find others that they will kick out of the gallery unfortunately right that doesn't actually fix anything but and I mean this is basically what it feels like though working with them right um because their blog back in 2023 was you know saying it's a developer problem lol like you know have fun um and I think that they could still do more to protect customers here, right? And this is where we sort of talk about defense and mitigation. Um, and when we're talking about no off and why I think it needs to be taken more seriously. Uh, so I actually took this uh during Matt's session this morning, right? Is um, you know, he has this bullet point up that you can't detect what you don't see. And this is very very difficult uh to observe this happening out in the wild, right? And so if we're talking about mitigation and defense from the customer side of things, right? So again, if we're looking at the consuming tenant, right, where we have our conditional access and we have our authentication and MFA requirements and we're like, you know, you got to do pass keys and all this great stuff and we've got defender for cloud apps and our CASBs and all that, right? That's all in that tenant. So uh out in our evil tenant where off and everything is effectively out of band, right? This is all just bypassing all those defenses that right the consuming uh organization is going to you know expect or hope or think is going to protect them here right and again even just sort of was thinking a bit further on this right if we're looking at that SAS application right and thinking of you know SSPMs right SAS security posture management uh solutions right these things are really just looking at all the knobs and dials on SAS applications right and um I'm not deeply familiar with them but generally right they're not going to be something that's going to be uh picking up on this type of vulnerability right so it's taking them sort of out of the equation and you know similar right like push security and other companies love like what they're doing with browser extension stuff right but it's really not something that's going to pick up on noth right so that sort of stuff is also taken out of the loop here from trying to detect uh you know the the problem um from a more traditional uh defense perspective Right? And then you know kind of other just brainstorming on on detection here right so what are you sort of left with and that's basically you know log correlation right so uh if we have our SAS application and we have our enter ID sign-in logs right we could do something where you know this is you know conceptual right where we're we're basically comparing our intro signin data to you know the application signin data right and looking for some sort of blank thing here where there's a sign in the SAS app but not an intra right but nobody's doing this for real Right? Um even if your SAS application at first supports any way to export or even gather, you know, robust signin log information, right? No one's sending this to their Splunk or their Sentinel. And um I actually thought, you know, Matt's uh talk earlier this morning was also very interesting on right the complexities of actually trying to do this, right? So for the most part, this is a feudal effort um for SAS applications to really expect this to be a way to write determine if if something's going on, right? So uh to me right the customers basically just completely left in the dark. Now again in the uh the case we opened with Microsoft right we basically asked them hey can you put some sort of attribute data on the service principle so that you know an organization will know if the app is consuming an unverified email address. Now again, right, I get that that won't ultimately tell you if the application is vulnerable, but it will at least give the app own or the the customer, right, who's sort of stuck in the middle between Microsoft who's saying LOL developer problem and the developer having no idea, you know, that they have a problem, right? The customer might have some awareness to potentially have conversations with their developer, ask what the mail claim is being used for, uh, and so on, right? And so for the developer, right? Um you know the mitigation really is you know to fix your application right um so checking the app regge for remove unverified email claim seeing if this is set to true or if your application right is older than uh June 2023 I'm going to really test your application so uh the one organization that we were working with that was really good about wanting to resolve this um they implemented some changes in their app right where they thought they were following things according to open ID spec uh but they asked us to go basically test their application again and we found it was still vulnerable. So, right, we had a few iterations of them um doing things where they they noticed that they did something in one region but not the other, right, for how their app was built. So, really important to test your app, right? test your application um you know for this uh you know fix it test it and you could just keep going on right I cannot stress it enough because ultimately um you know it is the only way to protect your application from no is to make sure that um you're not using mail claim uh for you know that user identifier. Um so right if we're going into graph explorer we can again just basically pull up this authentication behaviors um on an app registration and when we look at authentication behaviors we can look for this remove um unverified email claim right and so if this is set to false this basically means that the application is consuming right an unverified domain uh mail claim and again we can go run a patch on this right if say hey we check our app and we we know we're not using this so we can just get rid of it right and run a patch and we should just um you know then go basically do another get and you know get this back and see that it's true. Um you know and one thing I just want to highlight though is uh if you're trying to go sort of uh troll applications right to see what ones might have this set right if you're like a software vendor or you publish software um you know Microsoft said in their documentation that uh after June 2023 that this was set to false by default but actually finding it's like a backend behavior thing. So applications created after June 2023 uh for authentication behaviors you'll just get no data back right if it's false. So you won't actually find that attribute set um it will just be uh uh empty and you just have to go look at the date basically on the the app registration. Um, riot like I mentioned earlier, there are reasons to consume an unverified email claim, right? Again, an application might just want to send the email, right, to people, right? So, it's not in inherently um, you know, wrong thing to want the email address for users. Uh, you know, and again, we we suggested to Microsoft that they could just get rid of the ability to send this claim at all, right? And have applications um shift to using something like user info endpoint, right? So from an open id connect perspective again it's like a little more work for appde devs right but after they get that token they can also potentially go reach out to another Microsoft common endpoint here that's a user info endpoint where they can ask entry ID for other data about users right so here we can um basically call that endpoint and we can get email addresses and again these would be uh addresses that include unverified domains right because this is post authentication there's no concern that the app is you know, doing something uh stupid from an O perspective uh with that which will have a lot of this written up in a blog. Um you know, as I say with all my talks, uh because I own intro.ms, it is for sale to Microsoft uh for enough money. Um but sl.ro.ms and you can go read uh all about um you know everything here, right? So key takeaways uh basically with this um it is extremely dangerous, right? um you know between Office 365 integrations the potential for data that's out there right in applications uh you know when I was trying to talk with some folks who don't understand all the tech bits right I'm just like think of like a SAS application that means a lot to you and your organization for whatever you do right finance sales whatnot and then just like say right if I knew your email address right to sound all hackery right I could get into that application as you and get access as you to all the data and all the stuff you have in there right so whatever you want to with that stuff as an attacker. Um, you know, it's I think an extremely dangerous attack and it's going to continue to exist, right? Uh, basically in the MSRC case, uh, when I was talking with Microsoft before these talks, um, they basically still double down on this being a developer problem, right? And developers need to follow the standard, but unfortunately, it's one of those things, right, where, uh, they can put out all the guidance in the world. Most developers that are developing applications that are susceptible to this probably aren't out there reading the docs or you know uh hearing about the the problems here. Um right and again just as I mentioned earlier the the unfortunate bit is that customer is the one who's really stuck in the middle right they have no idea the app is vulnerable unless they go test it themselves right which is very timeconuming um and there's nothing on the service principle that would let them know that there could be even a potential uh for problems here so any uh questions interesting talk. Uh, thank you. Um, on the detection, maybe I'm just underestimating the complexity of this attack, but would it be possible to um check whether like the UPN and the male attribute have a mismatch because that's sort of like a prerequisite for at least one of the scenarios, right? Or is that Yeah, I mean, so yes and no, right? The problem you're going to have is um so if you're talking about from like an entra perspective, so I'm like a customer um which I didn't have in here. So guests, right? guests are really the other half of that equation where I was talking about Microsoft engineering themselves into like a corner. Um, when you take that common endpoint and mix it in with guests, right? So guests will always have a UPN that is different than a mail address. nugget that you could say well you know we can we can filter by guest or determine who is a guest right in a tenant but you can't always well there might be ways but I would I would still be concerned that it's not like bulletproof but um it is a a good question there so yep awesome thank you yeah the patch operation to put the unverified email onto the account is that literally just a GraphQL like the equivalent of a GraphQL kind of like write operation where there's no real authentication or authorization check on the right. So you do need to have rights, right? But again, if you're an I if uh that patch operation is happening in the attacker tenant, right? So figure the attacker has global admin. So there's no but it's trivial to get an entrant these days. Um, so kind of in the research I'm putting off like right like what rights would you need just because um you're you're probably in G and whatever tenant, but yeah, you you would need still rights to go uh modify that. And I did find um oddly that like if it's uh a tenant that had like um Exchange online enabled and some other stuff for the mailbox that it would actually block the ability to change email address. But again, it's easy. Just go create a new user and you know, off you go. So, but good question. Great talk. Thanks. Do you have plans to test the other applications, the remaining thousand and some change? Well, I mean that that's the problem, right? And I I mean this is like something that I was noodling on cuz I actually was going to scrape um Defender for Cloud Apps or whatever it's called now, right? They've got like 30,000 apps in there. Um but ultimately the problem that I find is like uh you really don't have a way to tell if an app is vulnerable without sort of observing or knowing how the app works. Right now in in some things generally you'd get some sort of error. So applications that um were following spec you would tend to get some sort of error if you tried to pull this off or they would just basically like see you as a different user. But right in most of our testing, the only way to really know that um there was a vulnerability is we'd go into the app, you know, sort of determine what it is, create some sort of data set in it, and then as the right attacker go see if we could observe the same data set. So, um and it's something that I'm like, oh, it'd be like a great use case for AI, but I'm like old and don't know AI stuff. So, um but no, it is interesting. I' I'd love to have a way to figure out like what is actually vulnerable. So, good question. Thank you. Is this vulnerability is it specific to Entra or could this also be happening in other environments similar to this? Good good question. So I mean I guess I'm not the only other IDP I know of like it put away like put to the side like Facebook and stuff, right? Um at least in my research it was really focused on enterprise stuff. Um the only other identity provider I know of is Google, right? That offers this sort of stuff. I don't know anything about Google or how the underlying mechanisms of their you know sign up with Google stuff works so I can't I can't really say but question I think I don't know if uh there was do you have no um one question for me um what uh what else could Microsoft be doing here to kind of help their customers do you have that page with like protecting the customers like what can they actually do here for it well that's what I think I Again, I wish that there was an attribute on service principles, right? Um, we can see that there's lots of data on service principles that is effectively mirrored from an app registration. Uh, again, I I get that it right, it could feel like maybe it's uh right trying to just um, you know, generate fear or something like that. But I I don't see anything wrong with flagging on a service principle that it's asking for an unverified email claim. customers of the applications, right, can then sort of make their own risk assessment uh on this and and potentially like you know maybe this is wishful thinking right that if we have all little groups of customers who are using these applications and they know this and they go talk to the vendor and write sort of like almost like community right sort of help to clean this stuff up because I I really don't think vendors are going to right I mean developers are going to develop um and they'll just keep doing this stuff right until they know better so Um, but yeah. All right. Um, let's give it up for Eric here. Thank you.