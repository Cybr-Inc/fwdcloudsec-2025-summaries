# Trust Issues: What Do All these JSON files actually mean?

**Video Link**: [Watch on YouTube](https://www.youtube.com/watch?v=j0YTgEKciCg)

- **Author**: David Kerber (AWS Consultant)
- **Talk Type**: Security

## Summary

This presentation introduces a comprehensive suite of tools designed to simplify AWS IAM policy analysis and understanding. The speaker demonstrates IAM Simulate (policy evaluation engine), IAM Collect (policy downloader), and IAM Lens (analysis platform) to address the complexity of AWS IAM at both micro and macro levels, providing developers and security professionals with better tools for policy development, testing, and verification.

## Key Points

- AWS IAM is the most critical aspect of cloud security but extremely difficult to understand
- Current AWS tools provide limited scope and feedback for policy analysis
- Three complementary tools provide comprehensive IAM analysis: simulation, collection, and analysis
- Real-time policy evaluation enables instant feedback during policy development
- Enterprise-scale IAM analysis requires automated tools due to complexity and scale
- Tools support both development workflows and production verification scenarios

## Technical Details

**IAM Complexity Problem:**
- Every AWS management API is publicly accessible
- All S3 buckets can receive external requests regardless of VPC configuration
- IAM has evolved over decades with layers of complexity and different policy types
- Scale challenge: hundreds/thousands of accounts with SCPs, RCPs, and complex policy interactions
- Estimated only 10% of IAM experts are named Matt, 30% named Dan

**Tool Suite Overview:**

**1. IAM Simulate - Policy Evaluation Engine:**
- From-scratch IAM policy simulator supporting all AWS policy types
- Handles SCPs, RCPs, identity policies, resource policies, permission boundaries
- Understands cross-account, cross-organization, and same-account interactions
- Knows service-specific quirks (STS, KMS differences)
- Provides three outputs: decision (allow/deny), explanation (line-by-line analysis), conditions

*Features:*
- 200+ end-to-end regression tests covering all scenarios
- Real-time evaluation in browser with keystroke-level feedback
- Policy validation to prevent invalid configurations
- Shareable policy examples via obscured URLs

*Capabilities:*
- Same-org vs different-org request evaluation
- Permission boundary interaction analysis
- Resource policy and identity policy cross-evaluation
- Conditional access evaluation and feedback

**2. IAM Collect - Policy Downloader:**
- Downloads all IAM-related data from AWS environments
- Supports multiple accounts, organizations, and partitions
- Includes principals, policies, groups, org structure, SCPs, RCPs
- Gathers resource policies from all available AWS services
- Stores data in conflict-free format for analysis

*Data Sources:*
- All managed and inline policies
- Group memberships and role trust relationships
- Resource Access Manager shares
- Organization structure and service control policies
- Most AWS service resource policies (with GitHub issues for missing ones)

**3. IAM Lens - Analysis Platform:**
- CLI tool combining simulation and collection capabilities
- Three main commands: simulate, who-can, principal-can
- Uses collected data to provide comprehensive request analysis
- Gathers additional context for accurate simulation

*Commands:*

*`simulate`*: Test specific requests with expectation validation
- Returns allow/deny decision with detailed explanation
- Exit codes enable automated testing workflows
- Example: `iam-lens simulate my-role list-bucket my-bucket --expect allowed`

*`who-can`*: Identify all principals with specific resource access
- Starts from resource policy, identifies relevant accounts
- Checks every principal for specified actions
- Returns principal-action pairs with conditional access requirements
- Example: `iam-lens who-can list-bucket,get-bucket-policy my-bucket`

*`principal-can`*: Calculate effective permissions for identity
- Aggregates allow statements from all applicable policies
- Intersects with permission boundaries, SCPs, RCPs
- Subtracts deny statements for net permissions
- Currently alpha: identity policies only, resource policies coming

**Demo Scenarios:**

*Access Key Creation Restriction:*
- SCP blocking access key creation across organization
- Verbose output shows policy-by-policy evaluation
- Demonstrates condition-based exceptions to SCP restrictions
- Real-time policy validation prevents invalid configurations

*Role Access Analysis:*
- "mega-danger-role" with Administrator access
- Trust policy allowing entire organization access
- Discovery of unintended access (product-development role)
- Chain analysis from valuable resources to potential compromise points

*S3 Bucket Access Mapping:*
- Complete access analysis for "area-52" bucket
- Shows conditional access requirements (VPC restrictions)
- Identifies external accounts and unrecognized principals
- Enables comprehensive access auditing across enterprise

**Technical Implementation:**
- Browser-based policy evaluation for real-time feedback
- Local data storage after initial collection
- Support for commercial and government cloud partitions
- Integration ready for CI/CD workflows and development processes

**Enterprise Integration Considerations:**
- Scaling challenges for large organizations
- Integration with pull request workflows
- Terraform plan limitations for policy extraction
- Development vs production verification use cases

**Future Development:**
- Historical CloudTrail log regression testing
- Enhanced Terraform integration
- Performance optimizations for enterprise scale
- Additional AWS service resource policy coverage

**Use Cases:**
- Policy development with instant feedback
- Security configuration verification
- Privilege escalation path analysis
- Compliance auditing and reporting
- Break-glass access validation
- Cross-account permission mapping

**Tool Availability:**
- IAM Simulate: Available via website with browser-based interface
- IAM Collect: Command-line tool for data gathering
- IAM Lens: CLI combining both capabilities
- Open source with active development and community feedback

## Full Transcript

Good morning everyone. Thank you all so much for joining us. Hope you've had a great start to Forward Cloud Sec. Um we have a great session coming up. But first, I'd like to thank our sponsors. Uh in particular, a uh gold sponsor in Promeo. If you'd like to learn more about their products and services, you can check out their booth in the vendor hall. Uh if you have any questions, uh definitely save them for the end of the session. I'll come around with a microphone. We'll get those answered. Um or you can put them in the thread that's going to be created for this talk in Slack. Um, with all that out of the way, uh, we have, uh, David Kerber, who is an AWS consultant here to present trust issues. What do all these JSON files actually mean? Take it away. All right. Thanks, Nick. Uh, audio is working. Okay, great. Uh, thanks to the organizers for letting me present here today. I appreciate the opportunity and thank you all for for coming out to listen to this talk. Uh, I hope you learned something and I'd love to hear your feedback afterwards. So, uh, for the purposes of this talk, there's two things you need to know. I am oddly obsessed with AM and I made a whole website about it. Uh the second thing is I make my own bread and for those who ask questions, there are four adorable little loaves of bread up here uh that we'll be handing out to those who are are going to participate. Okay. All right. So, uh some uncomfortable truths about cloud security. Uh everything's public. Every management API is public. Tons of data APIs are public. every one of your S3 buckets that exist right now, I can send a request to try and get data out of them at any time and that cannot be changed. For all of your private VPCs uh that exist where your network is safe, there are public APIs that I can try to use to access that network. So that's why I assert AM is the most important part of cloud security. But the problem is it's hard. It's like really really hard. So here's a quote shared with permission. I'm not going to read it, but the effect is has evolved over the years over a decade to solve different problems and different scenarios and we've introduced complexity with different types of policies and different policy statements and condition keys and when they're included and when they're not included and it's created a lot of complexity that's hard to hold into your head. Combine that with the scale of our cloud deployments. these days where you may have hundreds or thousands of AWS accounts, SCPs, RCPs, etc. So, I equate reading the AM docs with getting a field guide to map navigation. It's not actually the map. It's just something that tells you how to read maps. So from a first principles perspective, you you could argue it's very useful, but if I'm at the hotel here and I'm trying to figure out how to get to where the afterparty is, this isn't necessarily useful in the moment. Uh but given enough decades and enough opportunity to make mistakes, studying the docs, you can get a really good understanding of AM. But not many people have actually achieved that. I did a little bit of a for informal study and figured out that globally the people that actually understand I am about 10% of them are named Matt. So, thank you Matt for being here. We appreciate that. Uh I learned roughly 30% of them are named Dan and the rest uh have other names. Uh we're not sure what they are. There's probably an Ian in there, but it's it's really really hard to understand. That's what I'm getting at. So, not many people understand it. So I am is the most important part of cloud security and effectively no one understands it right. So what do we do about that? So we've got the IM docs. This is our guide book on how to read maps. AWS does provide a tool. I don't have time to go into it in depth but I would roughly relate it to this. It it is a map. So it's it's technically a map. It technically shows you things. Uh but it's fairly limited in scope. It's fairly limited in the details that it can show you at the pace at which it can update and give you feedback on your changes. So I want to suggest something a little different. When we think about understanding AM there's really two lenses you have to look at it right the the micro lens. Can you look at a single AM policy and understand what that thing does? Can you understand the different kind of requests that might go through that and how those different things might be evaluated against that policy? That's a hard problem by itself. The second lens is that kind of macro lens of I have hundreds of policies and thousands of policies across a broad deployment across multiple organizations. How do all of those different policies interact? Completely different problem and we need to think about and talk about both. So I'm going to talk today about three tools. One is an AM simulator. Uh the other one is a policy collector and the third is an analysis tool that kind of brings the first two together. So AM simulate is a from scratch uh written AM policy simulator. The way this works is you give it all of the policies that apply to a request. You give it SCPs, RCPs, identity policies, resource policies, permission boundaries and it understands how to interpret all them. Uh it understands all of the conditions that can be put in any kind of policy. It understands how uh resource policies and identity policies interact differently in the same account versus across accounts in the same org, different orgs, etc. It understands how permission boundaries work. It understands how STS and KMS are a little different from the other services and how they interpret resource policies and those things and it it takes all of that in and it gives you uh three things at the end. First, it gives you a decision. So, it tells you uh whether the request would be allowed, implicitly denied or explicitly denied. The second thing it gives you is an explanation of how it got to that answer. So, it looks at every single statement in every single policy and gives you a line by line analysis of how it evaluated that statement and whether or not it applied to the request and how that was used to get to the answer. And we'll we'll show that in a minute. And then it also gives you conditions under which that request may be allowed. So, let's say uh this request would be allowed if you were only coming from a specific VPC. it'll actually return that back to you uh if the request were to be allowed under any other conditions. Same thing with like uh roll session name, right? And then I put some thing in there about the tests. I I really just want to point out this is uh we've got 200 plus endtoend JSON in JSON out tests that try to cover every single scenario we can think of of same org, different org, RCPs, SCPs, specific service quirks, permission boundaries, all those different things are in there in a regression test suite. No software is perfect. This software is not perfect, but this has been very thoroughly vetted and when you give me a bug report, we'll be able to add it to that and it'll just get even better and better. Here's a video that I'll share a link to. Uh this is available on the website I was talking about. On the left here is basically uh VS Code editing a policy. On the right are requests that are being evaluated against that policy along with what you think they would be. And if you click on one of them, you can see how it interpreted every single statement. So here's a statement that didn't match, but you can see the action matched, the resource matched, but the condition didn't match because that value of S3 prefix wasn't quite what the policy was looking for. So if you're watching the video, you'll see a little typing in the editor, but I want I want you to watch that red box down there as the typing happens. So you'll see we're going to update that. And boom, it turned green. So because we have uh a policy engine that we can run literally anywhere, including in your browser, on every single keystroke, we're re-evaluating those requests. So you can get instant detailed feedback on how your policies are being interpreted by the engine. Uh also uh if you want you can uh save those and it will put the the policy and the scenarios behind a uh obscure but not necessarily private link so you can share it. So if you're trying to help somebody debug a problem or send some examples, you can send them the policy they should use and the effects that they would expect that policy to have. Okay. Second thing is a uh policy downloader. It's called AM collect. So many of our blog posts, our problems start with, we'll just download all of these things and and run this script. This does just that, right? So it downloads all of your principles, metadata about those principles, all of your managed policies, inline policies, your groups, your org information, your org structure, your SCPs, your RCPs, and uh most of the resource policies that are available in AWS. There's a very long tail and I have GitHub issues written up for what I think all of them are. So if you see one you're interested in, please go up it. Uh it also downloads all uh resource access manager shares and make sure it has those as well and puts them all on your computer or if you want straight to an S3 bucket and it stores all of those in a nice uh conflictfree way. So no matter how many accounts you have, no matter how many orgs you have, even like theoretically how many partitions you're operating under, so if you have a commercial cloud account and a .gov cloud account, you can download them all and they are all here in this one place, every single policy and setting that would be necessary to determine the outcome of an AM request. And it's right there and then you can do whatever you want with it. So let's put all that together. So on the left here we've got a request. Uh so that's got a principle, a resource, an action, and some some context. So maybe some request tags or whatever you want to put on it that goes through IM collect and we use the request to gather additional context. So we know what org the principle is in. We know uh the tags on that principle. We know metadata about the resource and we know all the policies that would apply to that request. So we get the RCPs for the resource. We get the SCPs for the principle all of those things and we push that through the simulation engine and then give you back that decision explanation and uh conditions. So IM lens actually ships as a CLI. So we'll look at some example commands and then we'll we'll do a demo of some commands and and try them out. So this one says simulate my role calling list bucket on my bucket and you get back allowed. All right instant that fast. Uh you can also set expectations. So you see there's a new line there that says expect allowed. And if that result is allowed, your return code from that is zero. Uh let's say we expected some kind of deny and it was allowed. We get a return code one. I'm hoping this is this is setting off some some light bulbs of how this could be used in some automated uh verification of your security configuration or if you're doing some testing as you're developing policies locally. Another command it has is called who can. Uh so who can do a thing to a thing. So here we're saying who can call list bucket or get bucket policy on my bucket. What that's going to do is start with the resource policy on my bucket. From there figure out what accounts it needs to look in and then check for every principal whether or not they can invoke those uh actions. and it returns a list of principal action pairs for everyone who's able to to execute that action on that resource. And the last command is uh called principle can. This is essentially you give it a role or a user and it adds up all of the allow statements that apply to that user kind of intersects them with any boundaries. So uh permission boundaries, SCPs, RCPs and then subtracts out the deny statements and gives you a consolidated policy for that principle. The reason I mark this as alpha is because it it does not yet take resource policies into account. It's only focused on identity policies right now. And I and I really want to make sure that's in place before I call this done. Uh but from a a principal policy perspective uh I feel like this is accurate and would love if you could try it out and and let me know what you think and give any feedback. So uh these three tools IM simulate, IM collect, IM lens. Uh let's uh let's try some stuff out. Move this a little bit. Okay. How is that font looking in the back? That's probably a little small. How's that? Is that readable? Okay. Thank you for the thumbs up. I appreciate it. Little bigger. Got it. We're going to get rid of the sidebar. There we go. So, here I've already downloaded all of my policies and anonymized all the account IDs. You can see there's a bunch of stuff there. So, the first thing we'll do is let's say we've got a vendor who requires access to our account through a user access key and secret. So, we want to say can we create an access key for that user? And it's explicitly denied. But why is it explicitly denied? So if we put verbose on here, we get a bunch of feedback as to how that request was evaluated. So we can see it was explicitly denied. And then when we look at the identity analysis, we could see it was allowed. So that's not our problem. Look at our SCP analysis. Oh, so it was explicitly denied by an SCP. And then it goes by OU and says, okay, here's where it was explicitly denied. These are allow statements. We don't need to look at those. So, here's the deny statements that applied to the request. And it even gives you the ARN of the SCP. So, let's just pull that thing up and look at it. Here's a uh idealistic but perfectly reasonable SCP that says you cannot create access keys anywhere. So, let's uh modify that to make that possible. So, we're going to say this SCP doesn't actually apply to this one resource, even though it still applies to all the other resources. And we're going to try this again without the verbose. And we get an error. Turns out um not resource is not allowed in an SCP. So, in addition to evaluating the policies, it's also validating them on every request. It's not going to let you do something to hurt yourself. It's going to check your work before it runs. So, let's try this. We'll add a condition to the SCP and we'll undo that. Do that. Put that condition in there and try again. And now it's allowed. You might not be able to see that in the back. Now it's allowed. So I I'm hoping between like the ability to run a simulation with an expectation and iterate quickly on your policies. Let's say you have an SCP that you need to do something kind of non-trivial with. Um, you can create a simple bash script of 10 or 12 lines to kind of test what should be allowed and what shouldn't be allowed and iterate pretty much as fast as you can type to understand if you're achieving your goals. Okay, let's do another one here. So, this is looking at a role. It's called mega danger role and that's because it has administrator access. Uh and if we look at the trust policy, it allows anyone within my org, which is good. That is a prod role. Okay, that seems like it makes sense, right? But let's see who can assume that role. Okay, so that just scanned my entire org to figure out who can assume that role. So we see prod break glass and we also see product development which is probably not what we meant uh when we said prod roles. So let's see just for fun who can assume that product development role. Uh let's see we'll scroll up here. So the first result is an IM user called Jacob is cool with a K. Um probably something we need to talk with Jacob about. And uh we we we just very quickly started from a valuable resource and went backwards to figure out, you know, where do we have a problem? Now, scope of this isn't how to fix that, but hopefully you can see how quickly you were able to find that. Okay, we'll do the last one here. Uh here we have an S3 bucket called area 52. This has nothing to do with aliens. That's a completely different area. And if we look at who can access that bucket, we see okay in the same account there's some users. There's some manage AWS policy roles which is a little weird but that's fine. Our mega danger role looks good. Looks good. Um here's our prod break glass. What's interesting about this one is you can tell here there's some conditions. So in the resource policy on this bucket, uh, prod break glass is allowed access only if the source VPC they're coming from matches this value. So when you're exploring and you're trying to figure out who has access to what, you don't have to like figure out the magic incantation under which a particular principle might have access, it's somewhat forgiving and it it tells you, okay, this principle would have access if these condition keys were set this specific way. Uh it also shows you uh since your entire enterprise cloud deployment can be downloaded to one place, you're not limited to like a single account or a single org. Anytime it runs into something it doesn't recognize, it puts that down here. So here's an account it didn't recognize. Here's some users it didn't recognize. You might need to look into that. So you could very easily take this from your file system, do an ls command, a little bit of XRS magic, pipe it into jq, and within about 2 minutes have a list of every single external principle or account that accesses any of your S3 buckets. Okay. Uh I was going to do one more. I don't think we're going to have time for that. So we can talk about it later. But uh so if the docs are like the book on how to read maps and access analyzer is kind of like that map. I I'm really trying to make IM lens into basically Google maps. I know exactly where I'm at and exactly where I want to go and you can see the turnbyturn ways uh to get there. Uh I have a bunch of road map ideas. Uh I would love to hear your roadmap ideas. Uh what you'd like to see in this and I'll share a link to the slides so you can look at these later. Uh but finally IM is way too important and too complicated to try and just do it in your head. You need good tools and my hope is that uh today you have some better tools than you did yesterday. Uh here are some links uh that you can check uh while we uh discuss any questions. Thank you very about the mom thing. By the way, do we have any questions in the room? I'll remind you if you ask a question, you do get bread. Hi. Uh yeah, thanks for the presentation. Can you hear me? Yeah. Yeah. Thought it was awesome. This is uh one of the issues we're dealing with at my organization right now. You know, we got a lot of tech tech debt. One of our awesome processes is that we get to manually check the IM policies or basically RO requests that come through for you know star all that stuff. So what does this tool look like scaling out for like an enterprise organization? So I I I can think of that in a couple perspectives. Um so like there's scale in terms of just sheer size, right? Um so far I've focused mostly on making it correct, not necessarily making it fast. and there's a lot of lowhanging fruit to make it fast. I think the the second thing about scaling to to enterprise is like integrating it into that pull request process. Um I don't know exactly what that story looks like because Terraform plans are are ugly and kind of terrible and they they don't a lot of times they don't even show you the policy that's going to be deployed in the plan. You have to see it afterwards. So primarily right now this would be used as a development and prod verification tool. Um, but if if you know of a way to get out of the Terraform plan reliably what that policy is going to be, it's a fairly simple exercise to like literally replace the file and and run that verification. Yep. Yeah. Thank you. Any other questions in the room? Oh, thank you, Abashek. Uh, one of the difficulties with using like service control policies and resource control policies is the fear breaking stuff. Um do you have any uh plans to um like simulate taking exist historical log data from like cloud trail or other S3 stuff and then simulating if I applied this SCP what would what things would I break based on historical log right so to to repeat the question because I'm I'm not sure your microphone was working is uh SCPs can break things we don't know about so do we have a way to maybe regression test against actual cloud trail logs, right? What was happening so we know what we're breaking and we're breaking it on purpose. Um, don't have any plans for that right now, but you're the second person to bring that up. Uh, and like most things AWS related, it gets incredibly complex kind of mapping between cloud trail logs and actions, but I appreciate that feedback and I'll definitely think about it. Hey, I'm not asking this just for the Brad, but uh, I'm looking forward to it. Um, how do you how do you validate that you are evaluating these policies in the same in the exact same way that AWS will evaluate them because uh a lot of us have probably used the AWS policy simulator online. Can I use this offline entirely without talking to AWS at all? Yeah, this runs entirely. So if you uh go to IM lens and follow the readme, everything runs completely on your computer other than downloading the policies. Once the policies are downloaded, everything runs completely on your computer. Now, as far as that like regression test story, right? How do we know everything's correct? Uh, I I think we're accurate within 99% and where we're not, please send me a bug and we'll we'll we'll get it uh to 99.9. I will be bugging you a lot. All right. I appreciate that. Thank you. Probably our last question in the room. If you have any additional ones, feel free to add it to the Slack thread. Um, I had two specific quick questions. This might be orthogonal, but do you guys capture organizational and account level tags as an output? I don't believe account tags are included, but that would be very easy to add. Okay. And then I was curious for like you did the anonymization of your accounts. Is that something that comes with this to do a mapping to like a friendly name for an account? No, but it's the good news is it's all just files. I did it in two minutes with like find and replace and with like a 60-second conversation with an AI bot, you could turn it into a said script and and just do it. Yeah. Thank you. Thank you. Can we please get a warm round of applause for David?