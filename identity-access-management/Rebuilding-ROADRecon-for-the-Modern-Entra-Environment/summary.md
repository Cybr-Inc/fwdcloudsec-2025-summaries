# Rebuilding ROADRecon for the Modern Entra Environment

**Video Link**: [Watch on YouTube](https://www.youtube.com/watch?v=dTUeAhzmIu8)

- **Author**: Thomas Burn (Reverent Security)
- **Talk Type**: Security

## Summary

This presentation details the process of rebuilding ROADRecon, a critical Azure enumeration tool, to work with modern Microsoft Entra environments after the deprecation of the Azure AD Graph API. The speaker explains the challenges faced in Azure security assessments, demonstrates the migration from deprecated APIs to Microsoft Graph, and introduces an alternative approach using undocumented IBiza APIs for stealth enumeration.

## Key Points

- Azure AD Graph API was deprecated and set to be retired, breaking ROADRecon functionality
- Microsoft Graph API requires finding first-party applications with pre-consented permissions for enumeration
- ROADRecon has been successfully rebuilt to use Microsoft Graph API while maintaining all original capabilities
- IBiza API offers an undocumented alternative with no logging or telemetry for stealth operations
- Detection opportunities exist through user agents, request patterns, and behavioral analytics
- Multiple client options available (Microsoft Office, Outlook, OneDrive) with varying permission sets

## Technical Details

**ROADRecon Overview:**
- Python tool that enumerates Azure AD/Entra objects (users, groups, service principals, permissions)
- Stores data in SQLite database with functional frontend for exploration
- Originally relied on Azure AD Graph API for all data collection

**Authentication and OAuth in Entra:**
- Four main components: user, client, identity provider (Entra), resource
- Pre-consented permissions allow first-party applications to access resources without user consent
- First-party applications are Microsoft-owned enterprise applications with default tenant presence

**Application Types:**
- **Application Registration**: Object describing the application with metadata, redirect URIs, secrets
- **Enterprise Application**: Instance of app registration that can be granted rights within directory
- **First-Party Applications**: Microsoft-owned applications (Azure Portal, Teams, Outlook) with pre-consented permissions

**Permission Types:**
- **Delegated Permissions**: Application acts on behalf of user
- **Application Permissions**: Application has its own identity and permission set

**Migration Approach:**
- Identified first-party applications with necessary pre-consented permissions for Microsoft Graph
- Created authentication script testing all first-party applications
- Found Microsoft Office client works best for most scenarios
- Built permission mapping table for required Graph API endpoints

**Alternative Clients:**
- Microsoft Office (recommended)
- Microsoft Outlook (limited conditional access policy access)
- OneDrive (limited conditional access policy access)
- Azure AD Connect (limited conditional access policy access)
- SharePoint Online Client Extensibility Module (no conditional access policy access)

**IBiza API Implementation:**
- Undocumented REST API used by Azure Portal
- No telemetry or logging available for detection
- Doesnt require finding pre-consented permissions
- Fewer API requests needed compared to Microsoft Graph
- Semi-working proof of concept available

**Detection Methods:**
- **User Agent Analysis**: Default Python AIOHTTP user agent (easily modified)
- **Request Pattern Analysis**: Unusual volume of Graph API requests in short timeframe
- **Client-Resource Pair Testing**: Attackers trying multiple authentication combinations
- **Anomalous Network Locations**: Authentication from untrusted locations
- **Behavioral Analytics**: Baseline normal Graph API usage patterns

## Full Transcript

This talk is brought to you by Run Reveal. I want to introduce Tom with a talk titled Rebuilding Road Recon for the Modern Entra Environment. Give it up for Tom. All right. Are we working? Yes. Okay. Hi everyone. Thanks for coming today. Um so yeah, as just introduced, we're going to be talking about rebuilding Road Recon for the modern entra environment. Um so just a quick agenda. Um, so I'm going to start off with a bit of an introduction into what security testing in Azure environments consists of, the complexities around that, the hurdles we commonly encounter. I'm going to introduce what Road Recon actually is for those of you that aren't familiar, why it needs to be rebuilt, what this to why this tool is important, and why you should care. We're going to take a look at OOTH in Microsoft Entra. it's kind of critical to understand how they implemented oorthth in order to understand what the changes for road recon means and how we need to think about using the tool. Um other kind of topics within this I'm going to take a look at the authentication consent flow um compare enterprise applications and app registrations and we're going to introduce some other concepts like consent first party applications and preconented permissions. We're going to take a look at my approach for rebuilding this tool, what the hurdles I encountered and basically the outcome of that. Um, and then we're also going to have a look at the IBA API. So, we're going to introduce essentially what this is, what I'm currently doing with it, and why it's important. And then lastly, we're going to take a look at some detection opportunities to understand what you need to do to detect road recon um, with this new age of Microsoft Graph. So, very briefly, who am I? Thomas Burn, security consultant at Reverse. joined roughly about three or just over three years ago now based in and around Manchester in London and yeah there's a photo there for you. All right so before we begin I wanted to give a bit of background into security assessments within Azure. So firstly Azure environments can be complicated. Azure consists of hundreds of different services. They all have their own new unique configurations and nuances. They each need to kind of interconnect with each other while kind of preventing public network access. and then they each have their own set of granular arback controls. Then you have like feature-rich services like Azure DevOps that have their own kind of world of problems um and vulnerabilities and then you've got existing issues like secrets management. But TLDDR it's complicated sometimes. So often when on cloud specific engagements the scope is much smaller than an organization's entire attack surface. Usually it's limited to a set of subscriptions that support an application or service. However, when on more kind of objective or strategic object strategic assessments like an attack path mapping or like a red team, we might well have the entire estate within scope. And with this comes the question, how do you even begin finding vulnerabilities in these environments? Which ones do you then prioritize and which ones will help you move uh closer towards your objectives? So for APMs at least, one solution is to kind of perform an assumed compromise. So you choose a target or like a starting point whether that be like a compromised users workstation or like a persona um i.e. like a compromised developer and that is great because it gives us that initial starting point and limits the number of resources we need to look at initially but can soon get complex again when we start pivoting towards other workloads and start compromising service principles with additional permissions. So when on these performing these collaborative engagements, it's often nice to have as much information as possible and map out the environment as well as we can to narrow down where to look. So how can we do that? One example is to use Road Recon. Road Recon, it's pretty simple. It's literally just a Python tool that um enumerates all of the objects like users, groups, service principles um and permissions within an entra tenant and stores it within an SQLite database and comes with a functional front end to allow you to um explore this information for later on. The way it does this is by using something called the Azure AD graph API. Um and it uses that and that only to collect this information. Um now you might be thinking right okay what is the Azure ID graph if you've not heard of it before it's essentially just a REST API and it provides programmatic access to entra formerly Azure AD and like we previously mentioned it allows you to kind of read and modify these objects users groups service principles applications conditional access policies it's used by hundreds of different Microsoft services and third party applications but as you're probably expecting there's an issue so the AAD graph API is deprecated soon to be fully retired that was meant to be today. Um, but Microsoft literally came out this morning saying they're extending support for certain applications until September. So, it was going to completely break road recon today, but it looks like it might work for a little bit longer. Um, but anyway, it's useful that we did this research, I hope. Um, so yeah, soon we won't be able to use Road Recon on engagements and it's an issue for two main reasons. So at best it's just another requirement that we'd need to give clients to ensure we have the necessary access in order to kind of enumerate these objects and look for vulnerabilities. At worst it's a complete blocker on these red teams or APMS because we don't have anything any information to help us move forwards towards these objectives. So what's the solution? The solution that Microsoft suggests for any application or service that's using the AD graph is to migrate over to the Microsoft graph API. Okay, sounds simple enough, but this exposes its own challenges. Right now, Road Recon doesn't support the Microsoft Graph API. We don't know if we can get all the information that we've been used to like we've had with the Azure AD graph. And Microsoft's implementation of OOTH means that we need to find clients with enough preconented permissions in order to access the information within the tenant. Okay, so what does this actually mean? Let me first just introduce the Microsoft Graph super quickly. It's a REST API like the AD graph, but instead of just being limited to um information within a tenant, it can interact with lots of different services like OneNote, Outlook, Exchange, Dynamics, uh 365 um and others. Okay, so let's take a look at what I meant by Microsoft's implementation of OOTH earlier on. So to understand this concept, I need to introduce how authentication works within um Entra. So broadly, we've got four main components. We've got the user, we've got the client that they're trying to, you know, use or access. We've got the identity provider, in this case, Entra, and we've got the resource they're trying to access. So, a user will access a client. In this example, that might be Microsoft Teams. And the resource they're trying to access might be the Microsoft Graph API. The client like Microsoft Teams will reach out to the identity provider and will request an access token for that user. Microsoft Entra will then request consent for the user in order to allow the application or the client to make authenticated requests on their behalf. Once that consent has been provided, then an access token is returned and that access token can then be used to access the Microsoft Graph resource. However, this is usually the flow with third party services. There is this concept that I mentioned earlier of preconented permissions for certain resources which means that they these clients can access resources and have certain um permissions these resources without needing to um get consent from the user. So let's have a look at what an application actually is within Azure. So there's basically two implementations of an application. You've got an application registration um which is essentially just an object that exists within Entra somewhere within a tenant and it describes the application um that that you've defined. So it will contain a bunch of different metadata like redirect URIs the secrets you know single sign on metadata app roles um and any published APIs or resource scopes. The enterprise application is essentially just an instance of the app registration. um since an app registration can't really do anything on its own. The enterprise application is an identity within the tenant that can be given rights within that directory. Okay, so I mentioned earlier again about firstparty applications and these are important because they give us a different set of access to a tenant than an application you would create. So examples of some firstparty applications are up there, but what exactly is it? It's just an enterprise application. The specific term first party just refers to the ownership of the application. So an application can either be first party or third party. And as you probably suspected, firstparty applications are ones that are created by Microsoft themselves. Um in each new tenant, there are several enterprise applications that are present by default um that make it possible for you to use them. Examples include the Azure portal, Outlook, Microsoft Teams for example. Um, so pre-conented permissions. Before we dive into this, it's important to understand there's two types of permissions within Azure. You've got delegated permissions, which is what we'll be talking about today. It allows the application to act on behalf of that user. And then you've got application permissions, which allow an application to have its own identity and its own permission set to perform its own requests. Okay. So as I mentioned earlier, in order to allow a client to access protected resources like emails or calendar data, your application needs the resource owner's authorization. This is given through consent. And consent is just a process where users can grant permission for the application to access the um protected resource. So the definition then of a preconented permission is one that has already been approved or consented for by Microsoft for each of these first-party applications and each of these first party applications will have consent for different scopes to the Microsoft graph um resource. Um so like I say these are the permissions and that would not require a user to have to consent to them each time. So um in the example here we can perform a password grant flow to the Microsoft Teams client using the Microsoft graph resource um like we saw earlier and the access token we get back hopefully that's big enough for you to see but there's an attribute called SCP and those are the scopes these are the permissions that um are already preconented for Microsoft Teams for that specific Microsoft graph resource okay so now we understand this we needed Well, I needed to find a way to identify firstparty applications that have all of the preconented permissions we need in order to enumerate the data from the tenant. So, pretty basically, I just created a script that authenticated to Entra using all of the first party applications and the Microsoft graph resource. Um, we then needed to figure out, okay, which clients actually work because not all of them can be used in a password grant flow. Um, and others require you to actually have knowledge of the specific redirect URL, which isn't always obvious um, and isn't always documented everywhere because Microsoft don't want that. Okay, so once we'd kind of got this list of filtered um, clients, I eventually found that the Microsoft Office client was the one that worked the best. Um, you might find though if you're on a certain engagement, um, the specific client you want to use like Microsoft Office is blocked by conditional access policies. So sometimes it's necessary to find an alternative that you can use or to use multiple. Um, so while my approach did work and it got me to where I needed to be, unfortunately for me, this really awesome tool came out literally as I was doing this research and kind of answered the main thing that I set out to do. Um, so the graph preconent explorer, um, it's essentially just a YAML file. Um, and there's a very simple HTML guey that passes that YAML for ease of viewing. Um, and it will just contain all of the first party applications and the preconented permissions they have and it gives you some details on how you can authenticate to those clients and get an access token. Um, and very very recently, Entercopes.com just came out um, based off some research Durkan um, has just completed um, as well. both very similar kind of things here. So off the back of this, I created a table of APIs uh that Road Recon now uses um with the these are the graph APIs and the permissions needed in order to authenticate to those specific endpoints. Um it's important to note you don't need every single permission listed there. You just need one of them. So the idea being here that you can take the permission for the specific endpoint, search it up within graph preconent explorer or entroscopes.com and you can find the specific client you need um in order to get an access token to then use with road recon. Um so some other usable clients I found as well as Microsoft Office are listed here. A few of them do have some limitations like Microsoft Outlook, One Drive, and Azure Active Directory Connect don't have the pre-conented permissions in order to enumerate conditional access policies and authorization policies and the SharePoint online client extensibility module can't get conditional access policies either. Um so going to do a quick demo um just on the use of it. So um let me see if I can pause that. So we just authenticate to Road Recon using username and password specifying the client and resource we want. We then use the gather module um which if you're familiar with Road Recon, it's very similar. We just have a new flag to specify the Microsoft Graph um resources to use. And then once we've gathered the data, we can use the guey to display that information. So we've got all the tenant information in there. We've got all the users within the tenant groups, devices. We can go into the devices and for each object will be the raw JSON output as well. If there's any other information that's not actually within the guey that you need for your engagement. Okay. Now I mentioned earlier on about the IBA API. This is very interesting because it's a similar thing to the Microsoft graph API. It's a REST API as well, but it's undocumented and it will it allows you to um authenticate to enter and enumerate details for users, groups, service principles, uh applications, etc. within a tenant. It sounds great because it sounds exactly like what the Microsoft Graph API does, but it's undocumented and it's used by the Azure portal right now. they're trying to phase away from it and implement Microsoft Graph more consistently within the Azure portal. But for now, these APIs still exist. Um, and so the website I've linked there is um, no do.cloud. It's um, essentially a set of documentation that's been completed by uh, an ex-conultant of ours, Alid Meta. He's done some fantastic research on documented these documenting these undocumented APIs. Um, so the advantages of possibly using this API with Road Recon is that it won't be logged. There is no telemetry available within Azure that will allow you to know if somebody has retrieved an access token for this API or is using it to enumerate against the tenant. So it also has the advantage that we don't need to find all these preconented permissions like we do for the Microsoft Graph API. Um, and yes, because of the fact that it's undocumented, it's not meant to be used directly. it's only meant to be used by Microsoft services. It's going to cut down the number of graph requests um that we need to send um in order to get all the information we need. Um so I'm working on well I've just published the code um so I've got a semi- workinging proof of concept on using these IBA APIs um within road recon. So, we've got two tools available or two implementations of Road Recon and um but it's uh right now it's still kind of work in progress because a lot of the APIs we still need to discover. Um and there's a lot of parameters that are just completely hidden but will allow you to gather more information from the API itself. So, we're still working on that. Um but yeah, hopefully we'll soon have a working version of Road Recon that use the IBA APIs as well as we've got the Microsoft Graph one as well. Okay, detection opportunities. Um, just really to detect a tool like road recon, it's difficult. Um, but what we can do is have a look at the graph activity logs because that is something that we do have available. The easiest and most, you know, the lowhanging fruit we can look at here is the user agent. Um, by default, as you can see there, the user agent used by road recon is just like the standard Python AIO HTTP request agent. And if not modified, it's a quick win to detect usage of Python tooling. Um, however, obviously it can be easily modified. Um, and that kind of breaks your detection logic. Another one would be to have a look at an excessive number of anom anomalous requests in a short time period. it might be worthwhile building some behavioral analytics within the tenant to detect for, you know, huge amounts of requests sent to the Microsoft graph um endpoints that would never otherwise be seen within the environment. It could be possible that with larger environments, this detection logic doesn't really scale well, but as the environment grows, so does the number of requests Road Recon needs to send in order to enumerate all of the objects within the tenant. So it might actually lead to a fairly uh highfidelity uh detection logic. Um other possible um things you can look at is um attackers trying to find a specific client resource pair that works within the tenant. I mentioned earlier that it might you might come across uh an environment that blocks access from a specific network location uh that's not trusted for your client you're trying to use or for the resource you're trying to use. And that what that will lead to is attackers trying a bunch of different client resource pairs that might not be common or traditionally seen within the environment. And this can be uh a way to quite easily flag um anomalous behavior. Um but really another great way would be to have a look at anomalous um network locations um i.e. somebody compromises an access token or compromises somebody's credentials via fishing. They then from their device over the public internet try and authenticate to the tenant. Um and that is an anomalous network location request. One that's probably implemented in most tenants already. But that would be a great one. But obviously if they have compromised an endpoint and are redirecting their network traffic through that endpoint, it's going to come from a trusted network location. So it's not going to be a beall end all. Um but really there's a cost value trade-off with trying to detect something a tool or a specific tool like road recon, one that has um uh one that um is just performing read actions. It might be that you're better off spending time and money investing in detecting more sensitive actions or state changing actions within a tenant rather than just trying to look at read requests against the the API. Um, so like I say, we've got a couple new PRs. So the Microsoft Graph um tool is available within Durkan's original Road Recon repository. Right now it's just under a slightly different branch. And then on my um personal repository I've got the working copy of the IBA stuff. Um, so I know we're running out of time slightly, so I'll move on to the summary. So yeah, to summarize, Rotary Recon is a really great tool. It's really useful for us on engagements. The AAD graph changes were going to completely break it, and we really needed to fix this. New undocumented APIs serve as a really promising method to go undetected and defense in depth is um is really crucial. So building a set of um detection logic around Microsoft graph logs and activity logs and ensuring that you've got um telemetry being ingested across the estate from multiple sources um is a great way to do that and strong conditional access policies. Um just a few shout outs here. I know we're running over time slightly um but that's pretty much it. Questions? questions. I'm just curious on the detection side of things. Wouldn't Microsoft Defender pick up on road recon? Defender for cloud. Yeah. So, possibly. Um, but again, what is it that Defender for Cloud is going to pick up on that, you know, we can't pick up on from the raw logs? The main use of Road Recon, I think, as far as I understand it is it picks up on like a specific user agent. But at the end of the day, all it's doing is just sending requests to the graph API. It's nothing inherently malicious or suspicious. And that's why it's really difficult to detect and might be better off within building your detection capabilities is not necessarily looking at like the initial access perspective or enumeration perspective but looking for somebody modifying or accessing more sensitive resources. Awesome. I have two questions. Uh the first one is a Biza IPA. Um there's no logging at all? None. Oh, that's awesome. Um the second one is okay. So a um I'm so uh Azure AD AD Azure graph is going away but um Microsoft graph is sticking around for a while. You said it's difficult to understand like how to feed that into road tools but you have more access to teams to like share to one drive is are you finding that to be the case? So there's different inroads from Azure um I'm not sure I quite understand the question. Well, so MSG graph is I mean there's a lot of tie-ins, first-party ties with uh with the graph. Microsoft's a graph, but so Azure ID is going away. So what are you really losing if you still have I mean Microsoft graph is Yeah. So so we're not losing anything. We've we it I initially thought we might um lose some capabilities or features with moving away from the AD graph, but actually we've managed to pull all of the information we've been previously used to using the new graph API. We'll do one more question. Um, so you mentioned before that the IBiza API is um obviously undocumented and that uh Azure is aiming or Microsoft is aiming to move away from that. So based on that, do you think that at some point they will then deprecate that? Yeah, more than likely. Yeah, I think at some point it will be like the AAD graph because it's built off the same. It seems like the the responses that it that it returns, the like the objects that it returns are very similarly structured to the AD graph. Um it's an old API. Um much like the AD graph wasn't that well documented. Um but yes, I I suspect that at some point it will become deprecated and or retired, but for now it's not. Okay. So for now it gives you the benefit of no detection but then it might not be available for you know exactly which is why we want to have the Microsoft graph one although there's like telemetry and logging available um for that it's going to be around for a lot longer so really when we're doing these engagements if we're on an APM it's not really so much we don't really care about getting detected so much we just want the information so we've got a stable option and an unstable option to some degree. Okay thank you. All right, let's give it up.