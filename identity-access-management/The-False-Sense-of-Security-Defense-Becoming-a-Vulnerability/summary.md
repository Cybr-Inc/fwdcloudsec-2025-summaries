# The False Sense of Security: Defense Becoming a Vulnerability

**Video Link**: [Watch on YouTube](https://www.youtube.com/watch?v=eq2FY0PPUow)

- **Author**: Nathan Eids
- **Talk Type**: Cloud Security / Identity & Access Management

## Summary

This talk explores how Just-in-Time (JIT) access tools, specifically Microsoft's Privileged Identity Management (PIM), can create a false sense of security. The speaker, Nathan Eids, demonstrates that misconfigurations, user behavior, and inherent tool limitations can undermine the principle of least privilege, turning a defensive measure into a vulnerability. The presentation provides concrete examples of these gaps and offers actionable strategies to strengthen security posture.

## Key Points

- **PIM Creates a Reality Gap**: While PIM is designed to provide time-bound, audited access, its common implementation with permanent eligibility and default settings leads to a high volume of low-quality justifications (e.g., "just cuz," "needed"), creating significant alert noise and making meaningful oversight difficult.
- **"PIM for Groups" Obscures Visibility**: Microsoft's recommendation to bundle multiple roles into a single group activation (PIM for Groups) reduces friction but sacrifices visibility. It prevents tracking of individual role activations and can lead to "scope creep" and lazy administration.
- **Critical Logging Gaps Exist**: Adding users directly to a PIM-managed group bypasses PIM-specific logs, creating a blind spot. An administrator can grant privileged access without it being visible in the PIM audit trail.
- **Over-provisioning is Rampant**: A significant percentage (averaging 75%) of eligible roles remain unused over a 90-day period, indicating that organizations are using PIM as a crutch rather than enforcing true least privilege.
- **Foundations Matter Most**: The core issue is a departure from foundational security principles. The ultimate fix is not just tweaking PIM settings but returning to rigorous access reviews and entitlement management to ensure users only have the permissions they truly need and use.
- **MFA Can Be Bypassed**: The default PIM MFA requirement does not re-prompt for MFA if the user has an active session. This can be exploited by an attacker who has already compromised a session.

## Technical Details

- **Primary Tool Discussed**: Microsoft Privileged Identity Management (PIM) for Microsoft Entra ID.
- **Core Concepts**: Least Privilege, Just-in-Time (JIT) Access, Privileged Identity Management.

- **PIM for Groups Vulnerabilities**:
    - **Microsoft's Recommended (Insecure) Method**: Permanently add roles to a group, and make identities *eligible* for that group. When a user activates the group membership, they get all roles at once without individual role activation logs.
    - **Logging Blind Spot**: If an admin adds a member directly to the group (via Entra ID groups panel) instead of through PIM, the log only shows "add member to group," not the critical "add member to role outside of PIM" event. This bypasses PIM's visibility entirely.

- **Proposed Secure "PIM for Groups" Architectures**:
    1.  **Good (Restores Logging)**: Add roles as **eligible** to the group and **permanently assign** identities to the group. This forces users to activate each individual role, restoring granular logging and visibility.
    2.  **Better (Stricter)**: Add roles as **eligible** to the group and make identities **eligible** to the group as well. This requires a two-step activation (first the group, then the specific role), providing double the logging and making it harder for an attacker to navigate.

- **Strengthening MFA for PIM Activations**:
    - **Default (Weak) Setting**: The default role policy setting `On activation, require Azure MFA` does not trigger a new MFA prompt if the user already satisfied MFA during their initial login.
    - **Recommended (Strong) Setting**:
        1.  Change the role policy setting to require a `Microsoft Entra conditional access authentication context`.
        2.  Create a corresponding Conditional Access (CA) policy that targets this specific authentication context.
        3.  In the CA policy's grant controls, require a stronger form of authentication, such as a `FIDO2 compliant hard token` or `certificate based authentication`. This forces a step-up authentication challenge at the moment of role activation.

- **Addressing Justification Noise**:
    - The talk highlights that justifications are often low-effort and not followed up on.
    - The recommendation is to build processes to validate justifications, such as checking if a provided ticket number is real, recent, and relevant to the requested role elevation.

- **Solution-Oriented Tools & Processes**:
    - **Baselining**: Track user activity to spot anomalies, but be aware that sophisticated attackers operating locally ("from the coffee shop down the street") can defeat simple location-based anomaly detection.
    - **Access Reviews & Entitlement Management**: These are presented as the fundamental, "unglamorous" work that truly matters for enforcing least privilege by regularly reviewing and removing unnecessary access.

## Full Transcript

Hi, welcome back to our last talk before lunch. Thank you all so much for joining. As always, we like to thank all of the sponsors who make Forward Cloud Sec possible. Particularly, we'd like to thank our gold sponsor, Run Reveal. They have a booth outside. Please go and talk with them and just at the least let them know how much you appreciate their support for making this event possible. So, our next talk, the last one before lunch, we have the false sense of security, defense becoming a vulnerability with Nathan Eids. Thank you, Nathan. I'm going to skip the rest of that. If you uh have any questions for me after the talk, let me know. What we're going to talk today is about just in time access, privileged identity management. Uh the theory behind them, the reason I chose privileged identity management is just because of how widespread it is. it's built into a lot of those Entraid D upper tier licensing um as well as some of its own licenses. We're going to take a look at some of the reality gaps around security that these tools and these you know um old systems kind of create and then we're going to look at ways to go about fixing that. So getting right into it, we're going to talk about lease privilege and I won't spend a lot of time here. We all know what lease privilege is. It's ensuring that our identities have the minimum necessary permissions, privileges and anything else to do their job, complete their task and nothing more. So from just in time access or sorry from least privilege came just in time access. And I have a few definitions from cyber arc and Microsoft here. Ultimately though what just in time access is is a timebound lease privilege. It allows us to take away a standing privilege and make sure that the identities only have it when it's necessary. And so from just in time access came privilege identity management. And there's some definitions here in terms from Microsoft, but ultimately if we try to cut through some of this noise, what is it? It's Microsoft service to provide just in time access. Um, and if anyone didn't know, King of the Hill is coming back in August. So there's a few references to it here. Um, ultimately though, privileged identity management gives us that timebound access. It gives us an audit trail. It gives us the ability to ask for justifications. It gives us the ability to ask maybe for an approval process. And so what that ultimately looks like, and we'll run through a basic role assignment, is we're going to select a role. We're going to select an identity. And then we're going to decide, okay, do we want this identity to have roles that are eligible to them or active? And for either one, we can assign a start or an end date. If they happen to go through like a change control process, maybe we can just say, "Hey, it's active, but it's only during a very specific time." Or we choose eligible. And we could do the same thing, keeping in mind that what typically ends up happening is what is happening right now, which is we go through and we're just going to choose permanently eligible, meaning the identity just always has this role available to them. Available, they still have to click a button. And so that is what happens here. So I don't have any roles as the user. I sign in. I go to privileged identity management. I go to my roles. And now I can see whatever roles I happen to have available. We can see that this one happens to be permanently assigned to them. And now I can go activate that role. And so as I click through here, I could do a few things. One, I could change the duration. I won't. Um, and the reason I won't is because typically no user actually ends up doing this. Uh they'll sorry, they'll usually just stick with the default. And then they'll provide a ticket number. They'll provide a justification if we require them to. And so background on that, every single role with privileged identity management has a single policy. And you can go make changes to that policy. You can ask for justification. You can ask for an approval process. You can allow whether or not you're going to say, "Hey, you can always be assigned this or not." And so this is where we start to get into a bit of that reality gap. So I mentioned the durations, and I'm hoping this shows up large. it does. Um, and so looking across a bunch of tenants that I typically see, what you end up getting is kind of a mix. You have a tenant where there's a duration of 1 hour for any role. You have 12 hours for that same role. And then you have your average. Well, 1 hour duration is fine for a global administrator. Typically speaking, you wouldn't want to have a long duration for someone that has a global administrator privilege. there's not a whole lot of things they need global administrator for. But if you start to try to do that same exact thing for say user administrator or group administrator, something that you would typically give to your service desk roles or Exchange administrator even for your Exchange team, you're what you're going to end up seeing is they're going to try to activate these roles all the time, one after the other, because you've made the duration so small now as part of their normal job. Again, if we go back to that lease privilege, this is part of their normal job. And so, they have to keep activating the role over and over again. And it's an unfortunate side effect of what was meant to be a strong security mechanism. But on the upper side, this is what we end up seeing. And so on the far left, you have the average activation days per week. So on the bottom there, you can have two of seven days all the way up to five of seven days. And so we can kind of see that they're using these roles because these are each an identity fairly consistently. And then then that same way we can see the average total activations per week, the overall activations. And so from here we can see 17 all the way up to 32 activations in a week out of those, you know, 2 to 5 days. And so what we've created is a mechanism where we see a whole lot of noise. Now, the old adage was, hey, we want to see an alert probably every time somebody gets a privileged role or or a role in general because they've, you know, increased their permissions. And we can still do that, but looking here, we can easily see what that can turn into. And what that ends up looking like from a uh alert perspective is something like this. There's no shortage of alerts. Something I often get asked is, "Well, can we fix this? Can we just ask for a justification and can we use that justification to decide, okay, well, we don't need the alert. We can trust this." And you could absolutely. Just keep in mind that most of your justifications are going to look like this. Because I needed the role just cuz uh I felt like it. Keep in mind, those are all actual justifications. Um, and so I set out and I was like, you know what? I see a lot of justifications. Let me take 50,000 or so and let me try to throw a rubric at it. Keeping in mind that a score of one basically just means that the justification exists. It's there. Uh, and then you get a plus one for any of these other mechanisms there as well. Keeping in mind ticket ID, I don't really care. If you really want someone to provide a ticket ID, don't require it in the justification. just turn it on in that RO policy and ask for a ticket ID. It's a separate control. But how did this turn out? The results were rough. Uh as you can see, most of the time we end up with that justification of a score of one. Two, three starts to fall off, but you really don't have much of a strong justification until you get to about maybe a five. Um and don't take my word for it. Sorry for the people in the back. This might be hard to see. Um, but this is kind of a breakdown of what these end up looking like. And so if we look at 765, we start to get much more information. We can kind of understand what they're actually doing when they give a justification what they're going to be using these roles for. Unfortunately, no, it never quite reached all the way up to an eight. But if you look at like four, need RO to update group. Three, I'm activating this role for my daily task at the company service desk like I mentioned before. Um, and this is part of the issues that we've created. And so then me, work, IM, and then again SD for service desk. Um, and keeping in mind that those at level one actually happen thousands of times each. Um, they are extremely loud. And then we get into Microsoft best practice. So for years, we've always heard Microsoft say, "Hey, for your global administrators, make sure you have less than five privilege roles less than 10." Great. And for the most part, we've held true to this. we were pretty good about making sure that we keep these numbers fairly small. That is until we started to introduce just in time access in privilege identity management. Then we started to have this idea that you know what it's not really assigned to them if we just make it eligible. So we can we can trust them with it because they still have to go do a bunch of other things to get to that role. Generally speaking, keeping in mind that PIM's main control is the fact that you have to go into PIM and click activate. Um, after that you might be able to ask for the justification. Yes, you can ask for a ticket number and then yes, you can have an approval process. But again, if you have an approval process and then you say have someone that has to activate a role 32 times a week, are you asking for an approval every time? Because I can guarantee what you're going to end up with is that rubber stamp approval. In the same way that they're barely giving a justification, the approver is barely going to look at that. And so we've started to break even Microsoft best practice here, which in part I'm okay with because then Microsoft decided to do this with their best practices. So use groups for Microsoft on role assignments, delegate the role assignment, activate multiple roles at once using PIM for groups. Microsoft started to embed a little bit of marketing into their best practice. Uh and so what they show here is let's take a bunch of people, let's throw them into a group and let's take a bunch of roles and let's throw them into that same group. Why? because quote from Microsoft which can reduce productivity and what they were referring to was just in time access and privilege identity management in itself because that time that it took which we saw it took maybe 25 seconds for me to activate my role was just too much. And so now we need to go in and we're essentially just going to give them all the roles all at once because that's what pin for groups actually recommends you do. This is the process. So you permanently add a role to the group. You take your identities and you make them eligible for that group. They now need to activate their group membership. And when they do, they get every single role that's part of that group. So let's let's take let's take a walk and let's say our Exchange administrators say, "Hey, we're always activating Exchange administrator. Can we just have a group for our team?" Sure. They come back a week later. You know what? These are really interconnected systems. We end up touching parts of Teams and SharePoint because of X, Y, and Z. Can we have those, too? Yeah. All right. You're a trusted team. We can give those to you. Few weeks go by and you have part of, let's say, your service desk come up. And they say, "Hey, we're always making changes to mailboxes for users. We're always going into Teams for this reason, and we always have to help people and recover things in SharePoint for this other thing." Great. We already have a group for that. we're going to put you in it. Why? Because typically when we have this kind of setup, what we end up with is a scope creep, a little bit of lazy administration, and then ultimately a loss of visibility. Because keep in mind, when we do this, we're never going to see anybody activate a role anymore. What we're going to see is when that role initially gets added to the group and that's it. When I go to activate my group membership, I could be getting access to three, four, five groups because keep in mind, it's still a group. I can go nest this into other groups and just completely lose track of everything. Um, and so what you end up with is a log that says, hey, somebody has activated their group membership. Awesome. What roles were included? Don't know. Microsoft won't tell you. So now what you need to do is you actually need to make sure you're tracking every single role that has or every single group that has a role and ultimately every single group that you expect it to be managed by PIM. Because the other thing that in the past has happened with this is Microsoft at one point or another decided hey for this let's ignore create new user and they fixed this partially. Um and when I say partially I mean they fixed it for roles in the normal sense of you how you would do this. So if you were to create a new user and add them to a role and then add them to a group that's managed by PIM, they will make sure PIM logs the fact that somebody was added to a RO, which is that top one there where hey add member to RO outside of PIM occurred. Great. Where's the one for group? So what Microsoft forgot to do is they created this tool. They marketed it in their best practice and then they forgot to always actually log the fact that it happened. And so what you can do is you can just ignore PIM altogether with PIM for groups. I can go in and I can create a new user. Sure. But I could also just go into groups the same way that you've always gone into groups. And I can just go to members or I can go to owners. I can add a member or I can add an owner. And what you're going to see logged is add member to ro sorry add member to group or add owner to group. And so Microsoft just didn't log the fact that py could see this at all. So again, you need to make sure that you're tracking these things completely separate from PIM because if you're only looking at PIM, you'll never know about it. And you'll end up with a whole bunch of direct assignments that PIM has no idea existed even though you should have gone into PIM if that's really what you wanted to do and just direct assigned it. But Microsoft decided that they weren't actually going to ensure they log that path. And then one of the final things we're going to take a look at in terms of that false sense of security is so we have PIM it's deployed and unfortunately lease privilege for the large part has been ignored. Uh we have these tools available to us and we're either barely using them or when we do use them we're not following up on it. And so you can see total assigned count versus total eligible count. we have a very large total assigned count for a lot of these different tenants. And this is about a representative sample um that I had to take so I could fit it on the page. But otherwise, you end up with a split. So there's some where there's total eligible count higher, some where there's total assigned count higher. But in all cases, if we look at the 90-day unused eligible count, what we end up seeing is about an average of 75% of these roles simply aren't used over that 90-day period. In some cases, I had to go back, you know, 363 days, I think was the top one that I tested to actually find when the last time a role was used. And so, by and large, what we're kind of seeing is PIM or just in time access as a whole kind of being used as a crutch in terms of, hey, if it's eligible, it's okay. We can just keep handing out all of these things. And so how do we go about fixing it? Well, generally speaking, it's not the easiest thing to fix. But what we can make sure to do is always have security in layers. So always make sure you're baselining. Baselining to try to find anomalies is very important. One of the reasons that I have the particular map graphic here on the left is because Permiso going back two years were was one of the first to start tracking scattered spider in various ways. Um, and so when we think of baselining, I just want to call out that, hey, it's not always going to be perfect. And so if we think of new threat actors today, you know, they're not coming from another state. They're not coming from another country. They're coming from the coffee shop down the street. And so access anomaly starts to fall apart a little bit in that it might not stand out quite as much. Okay. Well, we always have our activity anomaly to fall back on. Well, we can, but keep in mind again that we have a bit of a problem. We're having all of our users always go activate all their role all the time. And if we go to a service desk user, we go to an Exchange administrator, we go to a SharePoint administrator, really we go to any user, often times they're logging in and they're doing things at random times throughout the day. A lot of us are remote. We all end up just working all the time anyway. Um, and so we we do these things all the time. And so our activity baseline kind of gets broken apart as well. So, we always need to make sure we're baselining, but we need to ensure that that's not the only thing we have to fall back on. You guys knew I was going to come back to groups. You could tell I didn't like what Microsoft did. Um, so how do we fix what Microsoft recommended? So, we go back to true just in time access versus all at once. So, the version on the right is actually the exact opposite of what Microsoft did. So this allows you to keep that group administration mechanism if you really want it. But instead we're going to add the roles as eligible to the group and permanently assign the users or any identity to that group. Now we go and we have to activate the role. Still we get all of the roles available to us because they are part of the group. But now we still have to go activate each individual role. This gives us our logging back. Now we can actually see what people needed. And so if we went back to that other slide, now if they're not using it, we know that we can take it away. We don't have to go try to do a whole bunch of other work where we're trying to measure every single permission and break down exactly what role that actually comes from. Now we can see what's being used and not used, and we can again better manage that. Or you can do the version on the left. Your users probably won't like you if you do the version on the left, but you could. Uh, and what that is doing is you take an eligible role and you assign that to the group. you make all of your identities eligible to the group as well. And so now they don't see any roles at all until they first activate their group membership. Now they can see the roles. Now they have to go activate each role. On the bright side, if you do choose to do that, you get double the logging in terms of you see when they're doing both. So even if there's a group, you can probably measure some nesting that you see with that. Uh you can also measure how often those particular groups are even being used as well. Um, and you might confuse an attacker or two if they manage to get access. Because again, when we look at all of this, falling back on PIM as a security mechanism to say, well, the attacker won't have the role because it's not activated. Fair. The attacker can also click a button. And that's ultimately what what PIM is doing. And so, one of the last things I'll talk about is MFA. MFA is always important. Um, and Microsoft knows that and so they make sure that it's a requirement for PIM as well. They do that through that particular uh setting within the RO policy. Now, if you have it set to Azure MFA, which a lot of people before Microsoft went back and tried to fix this, that is what they had it set to. And what that message is basically saying is if 10, 15, 20 minutes ago, whatever it happens to be, your user logged in and they logged in and used MFA, which most likely they did, they're not going to ask for it again when they go to activate that role. You've already used MFA, you're good to go. And so what we need to do is we need to make sure that we're updating this to try to force MFA. So it's a mouthful, but you can switch it to Microsoft Entra conditional access authentication context and then require it for say privileged roles. When you do this in your role policy, you also need to make sure you have a conditional access policy that can do the same thing. And so if you set up an authentication context policy where the target is actually authentication context again for the privilege roles. Now what you can do is you can go into the grant control of that conditional access policy and you can force essentially a stronger version of FA. So let's say normally we kind of enforce all of our users to say hey always use the Microsoft authenticator soft token. It's a decent control and all of our user base should be using that. Great. Well, if you're going to go activate a role, instead we're going to force you to use say a 502 compliant hard token or certificate based authentication now you will actually end up with this message on the activation and you will actually be forced to use MFA again in a stronger form at that something the attacker might not even have access to again giving you a better chance at securing that. And then finally I'll come back to this. So the unglamorous work that actually matters. What am I getting at when we talk about this? Well, we know we can see a whole lot of things that are going unused. We can assume that there's a whole lot more that are going unused in the direct assigned. And so at the end of the day, what matters? Access reviews, entitlement management. What we need to get back to is the foundation. So we need to make sure that least privilege is actually being followed. So we came all the way full circle where we went from least privilege to just in time access that came from it and then the tools that followed up with that. But we forgot the first part. We need to make sure that our users actually need and are using these roles to begin with. And with that, thank you everybody. Thank you, Nathan. Um, as always, we'll have questions in the room and questions in Slack for folks who are remote. Uh, one question I wanted to start out with is, um, one of the things that you present at the very beginning was a lot of theater around requiring justification and then even more theater around just lots of permanently eligible. How much of this theater do you think is in just inherent to the notion of privilege identity management just in time access? How much of this is maybe just Microsoft's tool that kind of encourages this type of behavior? I'd say a lot of it comes from the tool kind of encouraging the behavior. And really the biggest thing that I I didn't get into here just for sake of time is what you really need when it comes to justifications and approval processes or you provide a ticket number. Again, I don't have to provide you anything. I can put a period and I can put a one for the ticket number. That's my justification and ticket number. The question is, are the IT teams or the security teams actually following up on any of it? Or is the only time you ever look at it during a breach when it doesn't matter because you can't make heads or tails of it and the attacker just typed in anything they wanted to. The attacker can also type in a random ticket number. And so, what we actually need to do is go deeper. We need to follow up on these things. Does that ticket number really exist? Was it created five months ago? Does it actually match the role that we're now elevating to? Those are the extra things that we really need to get to. Right. Uh any other questions from the room? Thank you for that overview. That was really cool to see. Um one question I had was it looks like you've looked into the scale of environments a lot. What guidance do you have to defenders looking to handle auditing ticket numbers or handling unusual locations, things like that at scale? Um, well, for the most part, I'm really hoping to be able to uh follow up and release uh some KQL queries for people u in their own environments, maybe some small tools to really kind of dive into it. Because honestly, that's what half of me prepping for this was was just trying to do that myself was diving into the data and trying to reconstruct logs back together to go, okay, well, which order did this need to go in to figure out everything down to a few things that didn't end up in here, which was can I show the time between somebody asking for an approver and somebody actually approving. So, you know, an average time even there was 15 minutes, but I think the quickest I was seeing was 20 seconds. So like again that rubber stamp approval is very real. All right. Uh thank you very much. Can we give one more round of applause to Nathan? Thanks all.