# When Your Partner Betrays You - Trusted Relationship Compromise In The Cloud

**Video Link**: [Watch on YouTube](https://www.youtube.com/watch?v=u1li6_B1hdA)

- **Author**: Sebastian Walla (CrowdStrike)
- **Talk Type**: Security/Threat Intelligence

## Summary

This presentation examines trusted relationship compromises in cloud environments, where threat actors exploit pre-existing connections between organizations to gain unauthorized access. Using two real-world examples involving the Murky Panda (Silk Typhoon) threat group, the speaker demonstrates how attackers compromise SaaS providers and cloud solution providers to laterally move into downstream customer environments and access sensitive data.

## Key Points

- Trusted relationship compromises involve pre-existing connections between organizations
- Two primary Azure mechanisms: cross-tenant access and multi-tenant applications
- Murky Panda exploited SaaS provider and cloud solution provider compromises in 2024
- Attackers primarily focused on email access for intelligence collection
- Detection challenges due to activity occurring in external organization tenants
- Service principal irregularities provide hunting opportunities for defenders
- Cloud solution providers with DAP have dangerous global admin privileges across customers

## Technical Details

**Trusted Relationship Definition:**
- Pre-existing connection between downstream customer and external organization
- External organization granted access to customer cloud environment
- Common examples: managed service providers, SaaS applications, BYOC arrangements

**Azure Access Mechanisms:**
- **Cross-Tenant Access**: External Entra ID tenant access to customer tenant
- **Multi-Tenant Applications**: SaaS application representations across tenant boundaries
- **Service Principals**: Enterprise applications instantiated in customer tenants
- **Delegated Admin Permissions (DAP)**: Cloud solution provider privileged access

**Attack Case 1: Multi-Tenant SaaS Compromise**

*Architecture:*
- SaaS provider application registration in provider tenant
- Service principal instantiated in customer tenant for M365 data access
- Application registration secret enables authentication as customer service principal

*Attack Flow:*
- Murky Panda exploited zero-day vulnerability at SaaS company (Q1 2024)
- Obtained application registration secret from compromised SaaS provider
- Authenticated as service principal in downstream customer tenant
- Used service principal permissions to read customer emails

**Attack Case 2: Cloud Solution Provider Compromise**

*Cloud Solution Provider Context:*
- Microsoft partner program for IT service providers and resellers
- Delegated Admin Permissions (DAP) for customer support access
- **Help Desk Agent Group**: Help desk admin privileges across all customers
- **Admin Agent Group**: Global administrator privileges across all customers

*Attack Flow:*
- Murky Panda compromised cloud solution provider (Q3 2024)
- Compromised user was member of admin agents group (global admin everywhere)
- Authenticated to downstream customer without MFA requirement
- Created backdoor user in customer tenant
- Added backdoor user to groups with application administrator privileges
- Used Python script to add secrets to privileged service principals
- Hijacked service principal permissions for email access

**Service Principal Backdoor Technique:**
- Application administrator role enables adding secrets to applications
- Adding secrets allows authentication as the application (permission hijacking)
- Targeted service principals with specific high-value permissions:
  - Mail.Read.All: Read all user emails
  - Mail.ReadWrite.All: Read and manipulate emails
  - Application.ReadWrite.All: Add secrets to other service principals
  - RoleManagement.ReadWrite.Directory: Assign arbitrary permissions (path to global admin)

**Hunting and Detection Strategies:**

*Service Principal Anomaly Detection:*
- Monitor for sign-ins from unexpected IP address ranges
- Alert on previously unobserved service principal credential key IDs
- Leverage Workload Identity Premium for conditional access policies
- Look for deviations from regular automated service principal behavior

*Cloud Solution Provider Activity Detection:*
- **Sign-in Logs**: CrossTenantAccessType attribute set to "serviceProvider"
- **GDAP Users**: UPN pattern "user_[32-char-hex-string]" for new GDAP mechanism
- **IP Address Redaction**: Partially redacted IPv4 addresses indicate cross-tenant access
- **User Creation Events**: Add user events with redacted IP addresses (high confidence)
- **Group Membership Changes**: Focus on application/global administrator group additions
- **Service Principal Modification**: Python requests user agent for credential additions

**Microsoft Security Enhancements:**
- **Current DAP Issues**: No MFA enforcement for partner access (changing September 2025)
- **GDAP Improvements**: Granular permissions, temporary access, partitioned customer access
- **Conditional Access**: Can force MFA requirements for cloud solution provider access
- **Future Enforcement**: Microsoft announced MFA requirements starting September 2025

**Detection Challenges:**
- Majority of malicious activity occurs in external organization tenants
- Limited visibility into upstream compromise activities
- Service principal activity should be regular/predictable (code-defined behavior)
- Mail access logs extremely noisy for legitimate service principals
- Cross-tenant IP redaction makes geographic analysis difficult

**Threat Actor Profile - Murky Panda/Silk Typhoon:**
- China-nexus advanced persistent threat group
- Specializes in zero-day and n-day vulnerability exploitation
- Primary objective: intelligence collection through email access
- Consistent focus on email systems across both attack scenarios

**Risk Factors:**
- Cloud solution providers with broad customer access represent high-value targets
- Legacy DAP mechanism provides excessive privileges (global admin everywhere)
- Multi-tenant SaaS applications create trust relationships across organizational boundaries
- Email remains primary target for nation-state intelligence collection
- Limited audit visibility into partner organization security practices

## Full Transcript

All right, welcome welcome to the final talk of the day here. We appreciate everybody joining. You want to grab your seats and uh and check it out. Uh this talk is going to be when your partner betrays you, trusted relationship compromise in the cloud. Uh want to uh just go ahead and thank one of our sponsors here, one of our bronze level sponsors, trust oncloud. Um you can check out more information with them uh trustoncloud.com or also in the lobby um if you haven't already seen them. Um uh additionally any questions that you have for this talk, we'll try to field as many as we can at the end. Uh and then also we'll have the slack. Um so if you want to post your question, we'll try to read those as well. Um and with that being said, let's give a a warm welcome here to Sebastian Walla. When your partner betrays you, trusted relationship compromises compromise in the cloud. All right, everyone. I am Sebastian Walla. Today uh I want to talk about trusted relationship compromises in the cloud. Uh, normally I'm doing cloud threat intelligence at Crowd Strike. Um, but yeah, let's get started. Imagine you're a threat actor and you're trying to obtain access to a victim's cloud environment. The first question that you will have to ask yourself is, well, how can you gain access to your target? The answer to that question, that's your initial access vector. Since 2024, we at Crowdstrike primarily observe um threat actors using valid cloud accounts to obtain initial access to uh cloud environments or exploiting public facing applications. However, in the past year, we observed this niche initial access vector where a thread actor basically compromises a trusted relationship to gain access to a victim's cloud environment. And this has popped up at least three times. While we do know trusted relationship compromises from on premise environments in the cloud, this initial access vector is rather rare. Therefore, I want to show you two examples of trusted relationship compromises that happened within the past year and how you could hunt for these in your environment. Before we dive into concrete cases, let's quickly define what we even consider a trusted relationship. As part of this uh presentation, we'll define it as follows. The first being you have some kind of pre-existing connection between your organization which I will also commonly refer to as downstream customer and some kind of external organization which might be a managed service provider that you're using a SAS software that you're using or if you saw Max talk about bring your own cloud that is also a trusted relationship and um the second condition that we have is that you somehow granted that external organization access to your cloud environment but how do you grant an external organization access to your cloud environment. Of course, there's the bad practice. You could just hand them out long-term credentials, but you don't want to do that. So, which mechanisms do the cloud service providers actually give us to grant access to those external entities? In Azure, two mechanisms come to mind. The first being cross-tenant access where you essenti essentially allow another entry ID tenant access to your entry ID tenant. And another mechanisms uh is multi-tenant applications where you basically have for example a SAS software or a representation of that living in the Azure tenant of your SAS provider and then you would have data that that SAS software is accessing living in your Azure tenant. In AWS you have cross account assumable roles. In GCP you have crossorganizational accessible service accounts or you can also assign permissions directly to users external to your organization. In this talk, however, we'll be focusing solely on Azure. Now, I brought two examples for a trusted relationship compromise in Azure. The first involves a compromised multi-tenant SAS application. The second involves cross-tenant access. To spoil in uh in both examples, the adversary ultimately used their access to compromise an application and read emails at downstream customer. Now, both trusted relationship compromises um that I'm talking about today have been conducted by Murky Panda. For those of you who don't know Murky Panda, Microsoft tracks this thread actor as Silk Typhoon. They are a China Nexus thread actor. They like to achieve initial access by exploiting zero day or end day vulnerabilities. And their end goal is to collect intelligence. And with that out of the of the way, let's take a look at the first intrusion. Now to understand what happened in the first intrusion, we have to look at uh multi-tenant SAS architectures in Azure. There you commonly have the following scenario. You have an application that's represented by an application registration and that application registration is living in the SAS provider's tenant and then you have for example your M365 data that's living in your tenant and you somehow want to grant that SAS application access to your M365 data. Now technically the way you grant access is via instantiating a service principle or if you saw Tom's talk before in track one uh he's referring to that as enterprise access uh application which is the more uh accurate term and you instantiate that service principle which represents an application registration and that service principle however is living in your tenant and then you grant that service principle access to your M365 data. Now what the SAS provider can then do is they can add a secret to their application registration and using that same secret they can then authenticate as the service principle in your tenant and that way gain access to your M365 data. Now what happened in this case which took place in Q1 this year is that Murky Panda exploited a at that time zero day vulnerability to uh achieve initial access at a SAS company and ultimately they almost certainly obtained access to the application registration secret of one of the SAS providers um apps and then leveraging the secret they could have authenticated as the service principle of um that application at the downstream customers. And that's actually what they did. Um we observed at least one case where they used this service principle to read emails at a downstream customer. Now this concludes the first example. Let's take a look at the second one. Now the second example of a trusted relationship compromise involves cross-tenant access. In this case a cloud solution provider had cross tenant access to a downstream customer and that cloud solution provider got compromised. So Murip Panda moved laterally from the cloud solution provider to the downstream customer leveraging cross tenant access and I spoiled it already. In the end they just use their access at the downstream customer to read emails. Now I mentioned this term cloud solution provider but what even is that? Well Microsoft has this partner program for IT service providers uh for example resellers but also managed service providers and participants of that program are called cloud solution providers. Now as part of that partner program, cloud solution providers need to provide support for their downstream customers and to facilitate that um these cloud solution providers need access to their downstream customers Azure tenants. And to this end, Microsoft came up with the concept of delegated admin permissions or short DAP. And DAP is realized via two special groups that live in the cloud solution providers tenant. The first being uh the helpes agent group which essentially if you're a member of the helpes agent group means you have helpes administrator priv privileges at all downstream customer tenants. And the second even more interesting group is the admin agents group. If you're a member of that group, this means you have global administrator privileges at all downstream customer tenants. For those of you who don't know, global administrator basically means you can do everything. Now, Microsoft has already recognized that giving someone global administrator privileges at all downstream customers isn't exactly ideal. And that's why they introduce GDAB or granular delegated admin permissions. Now, GDAB fixes a few issues of DAB. You no longer need to assign permissions permanently. You can also assign them temporarily. Uh you no longer need to decide between just granting health desk admin or full-on global admin privileges, but instead you can assign permissions much more granularly. And you no longer need to uh give access to all downstream customers, but instead you can petition access. You can have one group in your cloud solution provider that gives access to downstream customers A and B and the second group that gives access to downstream customers B and C. With that, let's get back to our concrete example. And this one happened in Q3 last year. And as I mentioned, Murky Panda compromised a cloud solution provider, but that cloud solution provider was still using the old DAB mechanism. So there were only help desk uh agent and admin agent groups. Now the compromised user in the cloud solution providers tenant was part of the admin agents group meaning uh mercury panda had global administrator privileges at all downstream customer tenants. Now leveraging this user uh Meripanda then authenticated to a downstream customer tenant. By the way they weren't prompted for MFA during this and then they created a new backdoor user in that downstream customer tenant. Now in the rest of this uh second example, all the activity that we will be focusing on will be happening in the downstream customer tenant because that's where our visibility as downstream customers is typically at. So Merkipanda had created this new backdoor user, but they didn't have any privileges. So what they did was add this new user to a bunch of pre-existing groups. One of which had global uh had application administrator privileges. Sorry. Uh one neat feature of application administrator is that you can add secrets to uh applications. And once you add secrets to an application in Azure, the situation is quite similar to our first case that we looked at. you can authenticate as that application and therefore hijack its permissions and get access to additional data. And that's exactly what they did. And they uh used a likely Python script. I'm saying likely because we never got the script. We only observed the user agent. That one was set to Python requests to backdoor a bunch of pre-existing service principles. Taking a look at which kind of uh service principles backdoor, we observe a pattern. Uh they all had mail readad application permissions. So they could read um users emails. Some of them had mail read write permissions. So they could have also manipulated emails. One of them had application application read write all permissions which essentially again allows you to add secrets to service principles. So the very same mechanism that they are abusing on this slide. And one of them even had role management readr directory permissions which allows you to assign arbitrary permissions to uh service principles and users and is therefore a straightforward way to global administrator. If you want to know more about privilege escalation paths, Fabian Vada is maintaining a map of this which is uh linked on the bottom of the slide in the footnotes. Now they backdoor all those very privileged service principles but they already said what they are going to do in the end. They are just using them to read emails and yeah that concludes our second example. Now we observed two examples of trusted relationship compromises. How can we hunt for this? Uh to answer this let's revisit some of the observed techniques. common to both intrusions. Ultimately, Merchup Panda locked into a service principle and read emails inside a downstream customer's tenant. Now, service principles represent non-human identities. This means their activities should exhibit some kind of regularity since their activity is defined in code and configuration. So, the idea would be to hunt for deviations from that regular activity. One easy idea would be to look for service principle signins uh from an unexpected IP address range. And in the second example, since Merkipanda added uh these additional credentials to pre-existing service principles, we could also look for a previously unobserved service principle credential key ID value in the sign-in logs. Note, however, if you have a service principle that represents an uh application registration of your SAS provider and your SAS provider legitimately changes their credentials, that value is also going to change. So um if you rely on the service principle credential key ID value might be noisy. Um if you have a workload identities premium license, you can not only detect but also prevent this because then you're able to assign conditional access policies to service principles and then you can assign uh you can use a conditional access policy to uh basically restrict signins to only IP address ranges that you associate with your SAS provider. Theoretically you could also look um for mail item access logs in your uh perview unified audit logs. Um but if you have a service principle that has mail read permissions and they are expected to use it, this log source is going to be very noisy and uh you will have a huge amount of data to deal with. So I don't recommend that one. Um unfortunately we don't have really any more visibility in the first uh case since all of the previous activity happened in the SAS providers tenant and um what we observed was the very tail end of the activity. Merkip Panda was essentially just logging into our downstream customers tenant and then went straight to data access or exfiltration, however you want to see that by reading those emails. In the second example, however, there's a couple of more techniques that happened and those involved the compromised cloud solution providers cross-tended access. The first thing you might have noticed uh when I presented that second case is that the cloud solution provider was able to sign into the downstream customer without MFA. And I found this weird. So I tried to look through the Microsoft documentation and I found uh I actually only this reference what you can see on the bottom here and what it basically says is that partners should stay by compliant by using MFA when accessing downstream customers should stay compliant to me reads like it's not technically enforced. Um I tried to get three different experts to actually try it out but unfortunately they didn't have time to do it. Um now I went on vacation uh had my slides finished and last week I checked again and I found a new page that uh where Microsoft basically announced that starting September 2025 we are going to enforce MFA when uh cloud solution providers are signing into partner center and partner center is what you would then use to sign into your downstream customer tenants. So hopefully they are going to enforce MFA in the future. If you don't want to wait, Favian B did some previous research on this and you can use a conditional access policy to force your cloud solution provider to use MFA when accessing your tenant. All right. Now, if we would be able to spot specifically cloud solution provider activity, we could specifically hunt for those actions and that data set would be much smaller um in contrast to searching across our whole user base. So, that might be cool if we could do that. Unfortunately, um the is it still working? Yeah. Uh the cloud solution provider activity has a few characteristics in Azure related logs that we can leverage. In signin logs, uh the cross tenant access type attribute is set to service provider if your cloud solution provider is signing in. Um however, that's only present in the sign-in logs but not in the audit logs. Meaning we would have to do joins all the time which can be costly. So I try to avoid that. Um, if your cloud solution provider is using the new GDAP mechanism, the user principle name would match the regular expression user underscore and then a um, the user principle name would match the regular expression user underscore and then a 32 character hex string. Um, that one is present in signin and audit logs, but that uh, requires that your uh, cloud solution provider is actually using the new gap. And um finally one thing that I found as a good uh proximity basically was um that if someone is using cross tenant access which is the mechanism under the hood that the cloud solution providers use when accessing uh your downstream customer tenant is that IP addresses are partially redacted by uh replacing numbers with an character X. If it's an IPv6 address um I only saw them fully redacted. So you would only see access for IPv4. I only see them partially redacted. Now um this redaction is present in signin and audit logs. So we can use that as a proxy basically to uh approximate cloud solution provide activity. Um but the redacted IP addresses of course also make it hard for us to spot unexpected IP address ranges that are signing into our tenant. So double-sided sword here. All right. um they use this uh cloud solution provider access to then create a new backd dooror user. So we could look for add user events that contain those uh reducted IP addresses. This one is quite reliable um as except for if you have a managed service provider that you expect to create new users as part of their uh normal workflow. But according to my research that is very specific to some customer environments and in most um this is quite reliable as a hunting query. Now they added um that user to several pre-existing groups again using that cloud solution provider user. Um so you could also hunt for that but this one I found is quite noisy. So you might want to filter it down for uh by looking only for groups that have uh like application administrator or global administrator privileges. So this one might be noisy. And uh finally they used this likely Python script to backdoor service principles. So we could look for um events where someone adds credentials to service principles that exhibit that Python request user agent. And here it really depends how you usually rotate your service principle uh credentials and uh if you use a different user agent there. All right, wrapping it up. Trusted relationship compromises also exist in the cloud. However, a large part of a threat actor's activity during a trusted relationship compromise happens in the external organizations tenant, which gives us as downstream customers only very little activity to hunt on. For adversaries like Murky Panda that like to leverage non-human identities, we can try to spot deviations from normal activity. This concludes my talk. Thank you for your attention and feel free to ask questions. Nice work, Sebastian. All right. Um, if we'll go around the room, anybody's got any questions, I can bring the microphone over. Uh, why do you think they were only looking at emails and like as a thread actor lens, do you think that they're going to get more mature? What what would you do in the situation to like optimally take advantage of that? I mean, they are nation state. Um and to them we often observe this from nation states in general uh emails are like the primary juicy source where all the interesting data is like if you have the proper target um think government or some other thing uh like policy makers um that is basically where you will find all the interest in communication. Um, if I would if I were to hack a startup, I would like look at Slack or whatever communication platform they are using, but I think in the traditional environments, email is still your best way to go. Hi, thank you. Great talk. Um, I have a question. So if I understood correctly, the attack succeeded because the the service principle was uh being was able to create a user and add it to the application admin group. Is that the default behavior? Does this like permission granted by default to these enterprise applications to be able to create users and add them to the application admin group? So uh they didn't use the service principle to create these users. They use the cloud solution provider user uh to create the backd dooror user and um yes it's default behavior if you are a member of the um admin agents group that means you have global administrator privileges so you can do that and adding them to um groups is also part of the permissions that you can do there. Thank you. Awesome. Any other questions in the group here? Okay. Um, well, we appreciate it. Let's go ahead and give a round of applause here for Sebastian.