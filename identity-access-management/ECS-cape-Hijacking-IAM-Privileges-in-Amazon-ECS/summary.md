# ECS-cape â€“ Hijacking IAM Privileges in Amazon ECS

**Video Link**: [Watch on YouTube](https://www.youtube.com/watch?v=WXdB-9pTqAU)

- **Author**: Nao Haziz (Sweet Security)
- **Talk Type**: Security

## Summary

This presentation reveals "ECScape," a critical vulnerability allowing containers in Amazon ECS to hijack IAM credentials from other tasks running on the same EC2 instance. The researcher demonstrates how a single container can use internal AWS protocols to impersonate the ECS agent and steal role credentials from more privileged containers, potentially leading to complete cloud environment takeover. This affects one-third of developers using orchestration technologies who rely on Amazon ECS.

## Key Points

- ECScape exploits ECS task isolation boundaries, allowing cross-task IAM role credential theft on the same EC2 instance
- Vulnerability works by impersonating the ECS agent through the Agent Communication Service (ACS) websocket protocol
- Uses Instance Metadata Service (IMDS) to obtain EC2 instance role credentials with ECS:Poll permissions
- Container Introspection endpoint provides necessary identifiers to construct authenticated websocket requests
- No misconfiguration required - IMDS is enabled by default and ECS instance roles have required permissions by default
- Affects hundreds of millions of containers according to AWS acknowledgment
- AWS classified this as "not a security concern" but updated documentation to reflect the risk
- Fargate launch type is not vulnerable to this exploit due to better isolation defaults
- Researcher received public recognition but no CVE assignment or bug bounty

## Technical Details

**ECS Architecture Components:**
- **Cluster**: Group of EC2 instances managed by Amazon ECS
- **Service**: Manages task lifecycle, handles restarts and scaling
- **Task**: Single running unit containing actual containers
- **ECS Agent**: Bridge between AWS control plane and EC2 instance
- **Container Instance**: EC2 + ECS Agent unit with unique ARN identifier

**Attack Vector:**
1. **Initial Access**: Custom container with reverse shell payload in Vertex AI training job
2. **IMDS Exploitation**: Access Instance Metadata Service to obtain EC2 instance role credentials
3. **API Discovery**: Use ECS:DiscoverPollEndpoint permission to get ACS websocket URL
4. **Agent Impersonation**: Query Container Introspection endpoint for cluster ARN, container instance ARN, and agent version
5. **Websocket Construction**: Build authenticated ACS websocket request with "sendCredentials=true" parameter
6. **Credential Theft**: Receive IAM role credentials for all tasks running on the same instance

**Required Permissions:**
- `ECS:DiscoverPollEndpoint` - Required to get ACS websocket URL
- `ECS:Poll` - Required to authenticate to ACS websocket service
- IMDS access - Used to obtain instance role credentials (enabled by default)

**ACS Protocol Details:**
- Agent Communication Service uses undocumented websocket protocol
- Carries task metadata including service names and configuration
- Transmits IAM credentials for all running tasks on the instance
- Uses SigV4 signing for authentication with ECS instance role

**Impact Scenarios:**
- Container without Secrets Manager access can steal credentials from container that has access
- Cross-task privilege escalation from low-privileged to administrator roles
- Agent impersonation exposes metadata about other tasks and instance configuration
- Works without any misconfigurations or special permissions

**Mitigation Strategies:**
- Disable IMDS access for individual tasks (not the entire instance)
- Never grant tasks ECS:Poll, ECS:DiscoverPollEndpoint, or ECS:* wildcard permissions
- Separate high and low privilege tasks across different instances
- Implement tenant isolation in multi-tenant systems using separate clusters/instances
- Apply principle of least privilege to task role permissions
- Consider using Fargate launch type for better isolation

**AWS Response:**
- Acknowledged issue affects "hundreds of millions" of containers
- Updated documentation to reflect cross-task credential access risk
- No plans to change default behavior in EC2 launch type
- Recommends Fargate for better isolation and blocking defaults
- Provided task-level hardening guidance in updated documentation

## Full Transcript

All right. Hey everyone, welcome, welcome, welcome. Um, so if you're here, uh, you are here for the ECScape hijacking IM privileges in Amazon AWS. Uh, if you guys all want to take some seats, file in wherever you can, find an empty seat if you can. Um, uh, just to start out here real quick, want to thank one of our sponsors for this presentation here. Um, so this is for Whiz, uh, one of our silver sponsors. Uh, you can find more information at whiz.io IO or talk to uh some of the Whiz folks out there in the lobby if you choose. Um and just in addition, any questions you have uh feel free to either post them on Slack or um at the end we'll try to take everybody's questions that we can um before uh before the break. Uh and I'll pass the microphone around. Um and without uh further ado, please welcome Nao Haziz for hijack uh EC escape hijacking IM privileges in Amazon ECS. Hello everyone. Can you hear me? Good. Yeah. Hi. So, what if I told you that a single container running in your cloud environment can use an internal AWS protocol and hijack the credentials of another more powerful container running on the same instance. In some cases, that's all it takes to take over your whole cloud environment. Today I'm going to show you exactly how can it performed using a vulnerability that I found called EC escape. It's a world playing between ECS and escape because it lets ECS task escape its assigned boundaries. So first of all I would like to introduce myself. My name is No Kaziz based in Israel and I'm software developer and security researcher at Sweet Security. In my free time, I'm also a DJ and a huge fan of Ras programming language. After this talk, I'm going to throw a party in my room. So, you're more than welcome to join me. Room 912. So, let's begin. We are here's a quick overview about what we are going to talk about today. First of all, we are going to have an ECS overview, what it is and how it works. Then I'm going to share with you my personal story of how I encountered this vulnerability. Afterward, we'll have a technical deep dive about the vulnerability itself, some impact and defense techniques, and key takeaways. And of course, we'll have a live demo. So, let's begin. Before we deep dive into tech, let me give you a reason to stick with me. According to a survey, a third of the developer using orchestration technologies rely on Amazon ECS. That makes it one of the most adapted orchestrators probably used in the world. That means that this talk is directly relevant to a huge portion of real world production workloads. So let's begin. First of all, what is Amazon ECS? Amazon Amazon ECS is a native container orchestration service. Essentially a simpler managed alternative to Kubernetes. It runs Docker containers on your cloud environment and it's deeply integrated with AWS core features like AM logging and networking. There are three core concept I refer to throughout this talk. A cluster, a service and a task. ECS cluster in simple terms is just a group of EC2s managed by Amazon ECS. This is where your containers are actually going to run. In each EC2 instance, you'll find a service and a task. A service is its way of saying, "Keep this task running for me. It handles restarts, scaling, and the deployment." A task is a single running unit. It contains the containers itself, which are the actual processes doing the work like your app, sidecar or logger. In ECS, each task has its own unique IM ro called task role. That means then even though they are all running on the same EC2 instance, they they have isolated permissions. As you can see in this slide, task one has one role and task two has another role and the task three has another role. ECS has two launch modes, Fargate and EC2. Fargate is fully serverless. just define your task and let AWS handle the rest. In EC2 launch mode, uh you the the EC you manage the EC2 instances yourself which mean that everything is running in your cloud environment. This talk is going to focus on the EC2 launch type because this is where the vulnerability actually works. Let's zoom in on how ECS over EC2 works. Each EC2 instance is assigned with a role called ECS instance role. This role contain permissions to pull Docker images and send logs to Cloudatch and many more. Essentially, it's the role that has the basic permission for ECS to function. On that instance, you'll find the Docker demon that actually runs your containers and a component called the ECS agent. The SCS agent acts as a bridge between the AWS control plane and the instance itself. The ECS agent authenticate to the control plane using the instance role and receive commands like start this task start that one. This whole unit EC2 plus CCS agent is what AWS refers to as container instance. I know it's a confusing name but it is what it is. You can find it. It has a unique identifier, an ARN, and you can find it in your Amazon console. Now that we got this out of the way, I let's move on to the discovery story. As you know, I work at Sweet Security and I was working on a EC2 sensor, which is the main component for detection and response. One day, my manager Ron Ron came to me and asked me, can you monitor ECS tasks? My initial response was, "Yeah, why not? Let's try." I thought to myself, as I mentioned earlier, the ECS agent is communicating with the Docker demon. So, I can do the same and get the data about the task themselves. Inspect the running container. I I noticed that every task that running by ECS has these labels which contains all of the information that I needed for the for the task like the the cluster cluster name task area. But one thing was missing the service name. I really wanted to know the service name of the task and this information is nowhere to found. This is a sad picture of me used from GP ch. So I started digging online and I found this endpoint called ECS task metadata endpoint version 4. It's a unique uh it's a unique endpoint that the ECS agent exposes to it to each task running on the instance. It returns tons of useful information like the task revision and family but most importantly it returned the service name which I really wanted. So here's where thing where things got interesting. I thought to myself that that because the ECS agent has the service name, it returns it using the the metadata endpoint that I showed you before. I can do the same logic and get it myself. I assume that the instance ro has permission to list the services. So I went to AWS console and surprisingly I found out that it's missing the list services permission. So how was the ECS agent receiving that info? The first thing I did was to set up a proxy server and watch the ECS agent traffic. I saw that it connecting to a websocket called ECSA. This is the ECS service. And I noticed something really weird. It was passing a query parameter called send credentials equals true. That immediately made me suspicious. Here's a real message that I captured from the websocket showing a real real role credentials over the websocket itself. So I had a thought, can I impersonate the ACS agent? If I'll be able to trick Amazon control plane into thinking that I'm the agent, can I get those tokens too? So I went to my voice again, Ron, and I showed him what I found and I told him, "Look, this is really interesting. Please let me research it." And Ron being Ron Nen and tell me you've got three days and this is where the hunt began. I'm so sorry Ron I have to share this meme. Now we'll deep dive into the technical aspect of the vulnerability itself. First I wanted to point out that the ACS agent is completely open source. I encourage you to go on GitHub and find it. It's really interesting. It was really helpful for me in my research and you have and if you find a and if you search for it and have some interesting founds or question feel free to reach out. I'd love to hear from you. So let's start with a quick look on the ECS instance role itself. It contains two specific permission discover poll endpoint and ECS poll. These per permission are crucial to the way that ECS works. So keep them keep them in mind. Now I'm going to show you how the ACS agent itself authenticate to the AWS control plane. The first thing is it does is using the instance role specifically the discover p endpoint permission that I mentioned earlier. It calls an API called surprisingly discover endpoint. This API returned by a specific URL. I searched online for this uh specific API and I found this AWS documentation stating that it should not be used outside of the ECS agent which of course only made me more interested. I really wanted to know what's going on in there. Here's an example of how the returned URL look like. I refer to it as Paul URL. It contains the region and Amazon AWS.com and some weird number that I'm going to cover later. This is a snippet from the ECS agent code itself. And this is where the magic happens. It takes the returned URL and construct using it a websocket request. It's actually what it does. It's taking the URL and construct the websocket with a bunch of identifier about the agent like the agent version, cluster RN, and the container instance RN. but most importantly the send credentials through flag. So how the agent authorization works? I'll start with explaining what is sifer 4. Sigv4. It's an algorithm used by AWS and this is AWS ensures that the request really comes from a valid credentials. It takes the the the user role and the request data sign it using a cryptographic algorithm and create a request signature then AWS control plane can validate that signature and see if the user have sufficient permissions. So in this example if I wanted to access the S3 bucket or the Dynamo DB I really has the permission it's and it's all fine. Now let's move over to the ECS agent itself and how it works. It take the instance role that I showed you before and the websocket URL it constructed then it sign it using SIGV4 and AWS process it and check one thing that is that it has the ECS p permission. This is why this permission is so crucial. This is the only permission needed to authenticate to the ECS service itself and to connect to the websocket. So let's summarize this uh this flow. The ECS agent using the instance role again and get the P permission. Then it sign it using CV4 and connect to the websocket. Then it receive back the all of the ECS task roles in the same instance. It receive all of the credentials of the running roles of the running tasks. Now what's going on over that web soocket? The connect the the communication is is happening using a protocol called ACS which stands for agent communication service. It's a websocket internal protocol used by the ACS agent to communicate with AWS. It's not documented but we know it carries messages like task metadata. This is where the service name that I've been searching for. It's in the task metadata. Agent level directives. So like configuration updates and more and most importantly the IM credentials for all of the running tasks in the same container instance. So to summarize the authentication flow first of all we use the discover pole endpoint permission and call the discover polint API receive the URL. Then the ACS agent constructs the websocket request using a bunch of identifiers. Afterwards, it sign it using SIG before. And lastly, it connect to ACS and receive all of the RO credentials. So now here's the real question. Can a task impersonate ACS agent? Let's find out. The first thing we need is the P endpoint URL, but we don't have the discover poll endpoint permission. What can we do? Remember the URL that I showed you before? So it has a unique unique structure. All of the things are essentially the same as as a the only thing that changes is the region and the backend server. The region we know so we can use it and for the backend server we can just brute force and find out. So this is what I thought and this is why I tried. Now that I have the URL, I try to use my role s it and connect to AWS. But sadly, I don't have the ECS permissions. So what can I do? This is where I had an idea. I can use something called IMDS, which stands for instance metadata service. It's a unique HTTP endpoint that available in every EC2 instance. It returns data about the instance itself like the region, instance ID and private IP address. And most importantly, it returns the instance role credentials. In ECS, INDS is enabled by default and each running task on the instance can access it. Which means that from each task, I can use IMDS and get the credentials for the ECS instance role, the same one used by the ECS agent. Using this technique, I can use IMDS call get the discover poll endpoint permission and get back the poll URL. Then I need to construct the websocket URL. But I have a problem. Where do I get this identifier? So I tried a lot of the stuff which I'm going to share with you now. Most of the identifiers I could you I could get using IMDS and the task metadata endpoint version 4. that I mentioned earlier. But one thing was missing the container instance ARN. It was a really headache. Here's me said it again. The first thing I tried is look at the instance role and I hoped that it has the permission to list the container instances, but sadly it hadn't. So I s I looked at the ECS agent and I found that it's getting the instance the instance ARN container instance ARN and trying writing it into a Bolt DB on the EC2 machine ECS has a has a feature to create a volume and mount point. So I I thought to myself, I can create the mount point to the host routt and get the bold DB and from there I can get the instance ARN. But it wasn't enough. This is a unique configuration that makes the vulnerability depend on it and it's not very common. So it's useless for me. Then I went to the instance role again and I I looked at these two permissions register and dregister container instance. These are the permission that used to register the container instance itself by the Amazon ECS agent. So I thought to myself maybe I can register myself as new container instance but it had a problem because then I receive back tasks that should be for another container instance not the same one as mine and I should be able to execute them. So I essentially breaks ECS because I can't execute the task. I don't have the permission to talk to docker demon. The other thing I thought is doing this and then dregister the ECS agent itself but again it's break the ECS uh the ECS uh and and I thought that I can get back the roles but again it's it stop the execution of other task which I don't want. This is where I got lucky. Inspecting the ECS agent, I noticed it has another unique endpoint called container introspection. This is a unique endpoint that it exposes to each running task on the instance. And luckily, it returns the cluster, the container instance, and even the agent version and hash. All of those I need to construct the websocket URL. This is me being happy. So now what that we have now because we have IMDS we can use IMDS and get the disco the P end ECS P permission then using the agent introspection we can get the needed identifiers construct the websocket URL and sign it using CV4 later we can authenticate to the control plane and receive back the task credentials for all of the running task on the same instance. So to summarize this flow what we are doing in ECScape. First thing we use IMDS and get the EC2 instance credentials. Then we get the P endpoint using discover P endpoint API. Afterwards using container introspection API we get the needed identifiers to construct the websocket URL. Then we sign it using SIG4 with the ECS P permission and lastly connect to the ECS service. Then we received back all of the task credentials. I showed it to my boss and he was very happy. Said it's a great success. What AWS documentation have to say about it? So I search online and I found this document documentation stating that a container ne never has access to credentials that are intended for another container that belongs to another task. That's the promise of task roles. isolation, security and separation. But as we saw using this technique, we can reach beyond that boundary. What is the impact? So let's say I have a task and I really want to access a MongoDB. But sadly when I use the AWS secret manager, I do not have the permission to get the secret for the MongoDB. Now and this makes me sad again. Now let's assume that I have another coexisting task in the same instance with the permission to get secret value. It can use its role get the MongoDB secret and authenticate to the MongoDB. Now what can I do using the technique that I showed you before I can I can get the other task permissions and authenticate to the secret manager. I receive back the access UR secret and connect to and access MongoDB which I haven't the permission to access before. Okay, one thing another thing to mention is that the agent impersonation goes beyond just test credentials. It also exposes metadata about the instance itself and other tasks running. So it's leaking data which were previously out of reach for me. To summarize the impact, we have cross task I am raw hijacking. It's a clear privilege escalation path. We can steal the the role credentials of any other task running on that instance. Second, we have the agent impersonation via internal protocol. the the agent returned the ACS protocol leaking data about other task and the instance itself. Luckily, lastly, it requires no misconfiguration. IMDS is enabled by default for ECS and the ECS instance role has the permission that I mentioned before before by default. Now, I'm going to share with you a quick demo. Oh, you can't see my screen. Just a sec. Okay, great. So, I created a cluster called DCscape and it has two unique uh Oh, I can see it from here. That's great. It It has two running task inside of it. Hyper and DC escape. Let's inspect the hyper. Hyper has this task ro ECscape administrator that has only one policy. It has administrator access. It means that it has the permission to access everything in my cloud environment. Now the other task that I use called ECS escape and the ECSS cape has the ECS escape role. This role contains one mo one policy as well which stands for deny everything. It means that basically I can't do anything in your cloud environment. Now I created an S3 bucket and called it forward cloud sec 25. Now let's go to the instance itself. Great. Let's start being sudo and then let's do docker ps. We'll see that the running containers are the escape task, the hyper ch task and of course the agent itself. Let's do use docker exec it and execute ourself in the task. Wait, why am I so do exec ah sorry I haven't bin a great stacks contain one binary called this escape. This is a command line tool that I wrote that implements the escape technique itself and try to use and try to delete an S bucket an S3 bucket. So let's run it with help and we'll see that we need to supply this bucket tree name. So let's use the forward cloud sec cloud sec 25 and see what's going on. Wait. As you can see, it prints out the full credentials for the other task and it states that the S3 was successfully deleted. Now, if we go to the S3 page again, you can see that if I refresh it, it no longer exists. So this is the real impact of the of the vulnerability itself. So let's go. Let's move back. Thank you. Thank you very much. Oh, there's options. Excuse me. You can see it. Oh yeah. Okay, let's move on. So add a recorder demo, but we are not going to see it. It was an ext failed. So the tool that I showed you called this escape is available on GitHub. It's completely open source. I encourage you to go and check it out. Here's a barcode. You can find it. H if you if you want to collaborate, talk with me about it. Feel free. I'm more than available to it. And of course I wrote it in Rust because well I love Rust. So so sorry for those of you who doesn't like this language. So what are the the mitigation techniques? The first thing you should do is to disable IMDS access to the task itself. If you disable IMDS access to the task, then the task won't be able to get the instance ro and therefore won't have the P and discover P endpoint permissions. Keep in mind to never disable IMDS to the instance itself because if you will the ECS agent won't be accessible to it and ECS itself will break. Amazon AWS has a great documentation about how you can disable the IMDS access for specific tasks. It depends on the network mode they have and you can find it online. You can take a picture of it now or if you want you can search it online later. Another thing is to never grant the task the poll and pull discover poll endpoint permission because if it has those permissions then it can do the same technique without using IMDS and without the instance metadata service. Same goes for ECS wild card because it contains those permissions. And please do me a favor, never give this permission to a task. It can be hijacked and in general it's a bad practice. So to summarize the best practices, first of all, separate high and low privilege task. Sensitive services should never run near risky task on the same instance. Second of all, isolate tenants in multi- tenant systems. If you are happening to implement a multi-tenant system in your in your code, never never give them a never share the same uh cluster because the role can be hijacked or at least separate the instances that they are running on. And lastly, minimize task ro permission. Don't give a task a permission that it doesn't need. Just give it the the needed permissions. So to summarize this talk what was going on I went to AWS and I sent a mail about the the vulnerability itself. AWS says that it's not present a security concern for AWS. This was their final ruling and another thing that they say that they are going to update public documentation and consider long-term defense and in-depth changes which mean that we are safe. This is the documentation that they had before as I showed you and now the new permissions are that task running on the same EC2 instance may potentially access the credentials belonging to other task on that instance. That's good. This is what I think going on in their offices about the acknowledgement. I was talking with AWS and again they said that they are going to change the documentation and give me a public recognition about it in their docu documentation change log. Also they say that they are going to draft a statement of appreciation for me which is nice. I get the appreciation that I needed. So to summarize this whole talk on EC2 task can and the ECS agent share one trust boundary. Okay task any task can use the discover poll endpoint and pull and pull permission to impersonate the ECS agent and hijack ROS on the same instance or leak data that it wasn't been able before. If there's one thing I want you to take you from this show uh from this talk is please task level hardening is essential AWS is not going to change the behavior that I show you for now. So one thing you should know is that ROS is your last line of defense. Please disable IMDS and don't give task roles they don't need. Keep that in mind and don't take my words for it. Here's a clear here's a here's a clear declaration for from AWS during our emailing showing that hundreds of million st while is accessible to this vulnerability. So yeah, it's not just another eda edge case. It's something that can affect each and every one of you. After I send them this presentation, they had a feedback. So I want to show it for you saying that Fargate has the already already has a better blocking defaults and Fargate is not vulnerable for this exploit. So I think they try to encourage you to use Fargate and this is the feedback that I got. That's it for me. Thank you everybody for being here today today. This is actually my first time speaking on a conference. So thank you very much. Here are my details. You can find them. This is my LinkedIn profile. We have a QR code that you can scan it and I'm happy to take questions. Thank you. Awesome. All right. Well, we'll kick some questions off. I've got one on Slack that we'll start with here. Um, so since uh you used IMDS as an initial access to get the credentials, would anything have changed if they were using IMDSV2 or just increase difficulty? No, it it does not affect anything. I can get the IMDSV2 token and use that. It's the same thing. All right. Um, okay. So, let me do some questions for the room. I see one over here to start. Um, did AWS ever u mention why a task needs access to Can you talk to the microphone? I can hear. Um, did AWS ever mention why a task ever needs access to the EC2 IMDS and like it should it seems like it should just be blocked by default? This is what I thought, but I think they can change it because maybe people rely on it. So if they are going to disable it by default now and on they are going to break some applications. uh the us the usage of IMDS is pretty obvious like you can get the end of the instance regen you can know in which environment you are running so I think that's the reason but since the uh each ECS task has its own IM role you would think they can do that without yes I I completely agree with you it is what it is all right uh more questions I got some way in the back back Here we'll go back here. Uh hey, so for the for the role like does it still assert the principle like who assumes the role? Like let's say if there's a um like default deny unless the principle is ECS task ABC like does that would that mitigate this or no like I'm trying to understand the question can you let's say let's say we have two roles right okay uh one is ABC one is I don't know CDE okay uh and both of them have a default deny but ex like with an exception of one task principle that has access to assume like one task can assume one role, the other task can assume the other role like would this vulnerability still work or would the would the deny on the IM policy prevent it? Erh like if if I'm not understanding the question of okay so uh let me I guess rephrase um so for for a policy uh when you when you showed the policy with a star right you can put a condition in and say um you can deny all assume ro uh events unless it's a certain principle. So I guess what what I'm trying to ask is um does it still analyze who the principal is assuming the role like uh if the task ABC is trying to assume the role of CDE and the CDE has the uh block in place that only task CDE can assume it like would that uh is that verification bypassed or is that sufficient to yeah I think it bypassed uh I I haven't checked it like in specifically that you are saying but because the task credentials are over the the ACS protocol itself I get the credentials themselves and and I can use it as is so I can assume the role from whenever I want. Gotcha. Do you mind sharing the uh the the QR to the GitHub uh again? Yeah, for sure. Thank you very much. I would like to talk with you later if you want. Awesome. Good question. Uh I've got another one just uh as we're um I'm looking through the Slack here. Um uh why wasn't this exploit granted a CVE? Any detail on that? Uh don't ask me ask AWS. I I I asked for them a couple of time to get a CV or some recognition and they did gave gave me some they gave me the they haven't yet gave me the doc documentation log change credit and also hadn't gave me the appreciation later but they said that they are going to handle it and I believe them. I haven't got any bounty or CV and this is their call. All right. Uh any more questions for the room? Anybody once twice? No. All right. Well, if there's any more questions uh for um afterwards, please do feel free to uh to stick around and ask uh for Nao. Um and then other than that, um just give a round of applause, please, for uh Nero.