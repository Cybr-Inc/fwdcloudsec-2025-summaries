# Keeping your cloud environments secure during a merger or acquisition

**Video Link**: [Watch on YouTube](https://www.youtube.com/watch?v=RiSBcFYUiCg)

- **Author**: Isaac Lee
- **Talk Type**: Cloud Security

## Summary

Isaac Lee discusses the often-underestimated complexities of integrating cloud environments following a merger or acquisition. The talk highlights critical security and operational risks that go beyond standard documentation, focusing on organization-level services in AWS and GCP. Lee provides practical guidance on handling identity management, delegated permissions, logging, and the broader web of dependencies to ensure a secure and smooth migration.

## Key Points

- **Organization-Level Services are Key:** The biggest challenges arise from services managed at the organization level (e.g., AWS Organizations, GCP Organizations), not from resources contained within individual accounts or projects.
- **Identity is a Prerequisite:** Migrating user access is a hard prerequisite. Services like AWS IAM Identity Center are tied to a single organization, meaning the acquired company's employees must be onboarded to the new SSO provider *before* their cloud accounts can be moved.
- **Handle Delegated Admins Carefully:** Services with delegated administrator permissions (like AWS GuardDuty, Security Hub, Firewall Manager) must have those permissions deregistered from the source organization before an account can be migrated.
- **GuardDuty Has a Legacy Complication:** AWS GuardDuty can be managed via the modern AWS Organizations method or a "legacy invitation method." If the legacy method is in use, it creates a separate association that must be manually broken before the new organization's GuardDuty admin can take over.
- **GCP's Hierarchy and Dependencies:** In GCP, IAM permissions are inherited through a hierarchy (Organization > Folder > Project), which requires careful alignment. Furthermore, GCP is tightly integrated with Google Workspace, and deleting a GCP Organization requires deleting the associated Workspace, a potentially destructive action.
- **Advanced Security Features Block Migration:** High-security features like GCP's VPC Service Control perimeters must be disabled before a project can be migrated between organizations, which can conflict with compliance requirements.
- **Plan Extensively:** A successful migration requires a well-documented plan, a backout strategy for every step, and early involvement from all stakeholders (Security, Ops, Network, Finance, etc.).

## Technical Details

- **Cloud Platforms Mentioned**: AWS, GCP

- **AWS Specifics**:
    - **AWS Organizations**: The central management service. Moving an account from one org to another is the core migration task.
    - **IAM Identity Center (formerly AWS SSO)**: Limited to one identity source per organization. This makes migrating users to the acquiring company's SSO a prerequisite for moving accounts.
    - **Root Credentials**: AWS now offers centralized root credential management at the organization level, which is the recommended best practice. If not used, credentials for each account must be manually obtained or reset.
    - **Delegated Administrator**: A feature of AWS Organizations to delegate management of services like GuardDuty, Security Hub, or Firewall Manager. The delegation must be removed before migrating the administrator account.
    - **GuardDuty**: Can be configured via AWS Organizations (recommended) or a "legacy invitation method." The legacy association must be manually severed.
    - **Other Services Mentioned**: EC2, Lambda, S3 (as examples of services contained within an account), CloudTrail, CloudWatch (for logging), Resource Access Manager, Shared VPCs, Route 53 (as other potential complexities).

- **GCP Specifics**:
    - **GCP IAM Hierarchy**: Permissions can be set at the Organization, Folder, and Project levels, requiring careful alignment during migration.
    - **Google Workspace**: Tightly integrated for user and group identity management. Cross-domain sharing can be enabled as a temporary measure, but full user migration is necessary. Deleting a GCP Organization is tied to deleting the Workspace account.
    - **Custom IAM Roles**: Organization-level custom roles in the source org must be recreated or handled in the destination org.
    - **VPC Service Control Perimeter**: A security feature that acts as a firewall for GCP APIs. It must be disabled to migrate a project between organizations.
    - **Cloud Logging**: GCP's logging service that needs to be integrated.

- **General Methodologies & Concepts**:
    - **Log Management/SIEM**: Integrating logs (e.g., CloudTrail, Cloud Logging) from the acquired environment into the existing SIEM (e.g., OpenSearch, Splunk) is critical. Care must be taken not to lose logs during the transition.
    - **Web of Dependencies**: The concept that the cloud environment is interconnected with many other systems like SSO, CI/CD pipelines, network infrastructure, and finance/billing systems, all of which have stakeholders who must be involved.
    - **Migration & Backout Plans**: The necessity of having a detailed, documented migration plan and, just as importantly, a tested backout plan for each step in case of failure.

## Full Transcript

All right, everyone. This is our last talk before the closing talk. This is keeping your cloud environment secure during a merger or as a acquisition. I should drink more coffee. Yeah, same. Isaac Leo Lee with Isaac Lee Pal. And we'd like to thank our gold sponsor for this one, Run Reveal. Thank you, Rich. Um, so picture this. The company that you work for just acquired another company. They have their existing cloud environment. Your company has theirs. You're the person who's responsible for cloud security or you're on the team that's responsible for it. And you need to integrate their cloud environment into yours. Should be pretty straightforward, right? All the cloud providers have uh documentation that'll tell you how to move things from one organization to the other. How hard could it be? Um the fact that I'm doing this talk should tell you that it's not quite that simple. So, a little about me. My name is Isaac Lee. I've worked in a bunch of different security roles over the years. Lately, I've been doing a lot in the cloud security space. And perhaps most importantly to this talk, uh, at the last role that I worked in, I did a lot of the cloud migration and integration work for three of the acquisitions that we did. Um, so I'm going to do a little agenda here. I'm going to start with the scope of the problems. Um, because this is a 20-minute talk and if I tried to cover everything, it would be impossible. Uh I'm going to give a few specific examples from a couple of the cloud providers and a couple of examples from beyond the providers. Um so let's get into it, shall we? So when you move an AWS account from one AWS organization to another one, it for all intents and purposes stays mostly the same. Yes, there are some caveats to that, but anything that's strictly within that AWS account is still going to be there. your EC2 instances are still running. Lambda functions still executing. Anything you have in S3 is still going to be stored in S3. But uh the areas where you'll start to run into issues that can uh introduce some fun new operational risks are uh at the organization level and the broader company level. And just for the sake of clarity for the rest of this presentation, if I use the word organization, that's referring to the concept of an organization within the cloud provider. So AWS organization, GCP organization, etc. Um, with that, I'm going to start with a few examples from the cloud providers. Uh, I have the most experience with AWS and GCP, so I'm going to be focusing on those two. Um, these are largely going to be things that maybe are mentioned in the documentation if you know where to look, but you have to know where to look. But they're things that could be easy enough to overlook if you're not as familiar with some of the organization level services. Um here I'm going to start with AM identity center which if you're not familiar with it is basically AWS's solution for uh identity federation. It used to be called AWS SSO. That rebrand happened a couple of years ago, but it'll basically let you connect your SSO provider to all of the AWS accounts in your AWS organization, you know, from the organization level rather than having to do that individually in each account. normally pretty convenient, but uh let's read the documentation. Uh font size might be a little bit small. Doesn't matter. I'm going to read the important part to you. You can have one identity source per organization. What this means is that once you start moving AWS accounts from the source or into yours, anyone who had access via their AM identity center instance isn't going to have that access anymore. Uh this should be pretty straightforward, but it's uh again something that you might be able to overlook. So here's just some general guidance. IM identity center instances are org specific. You get one instance per org and one identity source per org. If the company that you're acquiring is using their own AM identity center, then getting their employees onto your SSO provider is actually a hard prerequisite for migrating their AWS accounts, provided that you want them to continue to have access to their AWS accounts. if they're using individual SAML identity providers uh in each AWS account, those will keep working and then it just becomes a question of how long you want to continue to support that. On a similar note, root credentials, uh there's really two reasons that I feel that I need to mention the root credentials. The first is that until recently, root credential management was kind of a hard problem at organization scale. If your company had progressed past the point of having a single security or ops person that uh handled them, then there were a few different ways to deal with it and they didn't all scale particularly well. The other reason is that about a year ago, a little less than a year ago, AWS introduced centralized root credential management for your organization, which kind of completely solves this problem, but it also means that the best practice around this has changed significantly and pretty recently at that. Um, this one's going to be a little bit more straightforward. If you have centralized root access enabled, just use that. you can delete the existing root credentials from there and of course make sure that the company that you're acquiring doesn't have any workloads relying on root access keys or root signingerts. They shouldn't, but you never know. Um, if you don't have centralized root access enabled, you're kind of back to the old way of doing things. Uh, basically just have to obtain the root credentials for each of the AWS accounts and bring them under your own management. If you don't have access to the old root credentials, if for whatever reason the company you're acquiring lost them, that's actually not an issue anymore because you can update the email and the phone number on each of the AWS accounts from the AWS organization service and that will let you go through the password reset flow and the MFA recovery process and handle it all that way and not have to open up support cases with AWS. I'm also going to talk about some other services and really one in particular that you can use with AWS organizations. Basically AWS has the concept of a delegated administrator account where you can delegate permissions for certain org level services to other AWS accounts so that you're not having to use the management account all the time. Uh, think delegating AWS firewall manager to a an account that's owned by your network team or security services like Guard Duty. Those could be delegated to a security account. You might imagine can take a little bit of special handling. Again, documentation. If the account is a delegated administrator, you must dregister the delegated administrator permissions before migrating the account. You may be wondering, what happens if you don't? Well, this happens. You get actually a fairly detailed error message that basically says you can't remove the delegated administrator account from your org until you dregister it as the delegated administrator. So, this solves it for most of the AWS services that support this, but there's one in particular that I want to call out because it's kind of a special case, and that's guard duty. Guard Duty's administrator account can be configured as a delegated administrator in AWS organizations, same as most other things, or it can be configured manually using what AWS refers to as the legacy invitation method. And uh they don't want you to do that. Um, these are excerpts from three different pages of documentation about the legacy invitation method. All of which have notes that say guard duty recommends using AWS organizations instead of guard duty invitations to manage your member accounts. Um, but the fact that this method of managing guard duty exists at all kind of presents a fun potential complication for your migration work. It's totally possible to migrate the member accounts and even the guard duty admin account uh from another org into yours and then the guard duty delegated admin in your org can't see them because they're still associated with the old admin account or in the case of the admin account it is a guard duty admin account. So with that general guidance for guard duty, dregister the delegated admin account as you would with every other org service. If it doesn't, if the org of the company that you're acquiring doesn't have a delegated admin account for guard duty, check for an admin account that's using the legacy invitation method. Dissociate all the member accounts from the guard duty admin. You'll have to do this either way. It's a prerequisite for both parts of it. And do note that this won't disable guard duty on those accounts. It's just severing the association. Once you migrate the member accounts, they should get automatically picked up by your delegated admin account if you're using one. Um, if they aren't, or if you're still using legacy invitation method, just add them manually. I'm going to shift gears a little bit here and talk a little bit about GCP. Um, I'm not going to get too in the weeds with this, but basically GCP's AM hierarchy is such that you can assign permissions to identities at the project level, the folder level, or the organization level. Um, this is kind of a different way of thinking of things than in AWS. I'm going to try not to focus too much on the similarities and differences, but the main thing to be aware of when you're doing a migration is making sure that you align the permissions at the folder level and the organization level um for the projects that you're migrating into your organization. This will take a little bit of work making sure that the people who have access through Google Workspace, service accounts, other identities have the same access that they did and that that's an appropriate level of access. If you're using custom AM rules at the organization level uh in GCP in the source organization that is those will need to be handled um kind of carefully. Uh and this is also something that GCP explicitly calls out which I am pretty happy about. And on that note, Google Workspaces is integrated pretty tightly into GCP um for uh basically identity management for human users. You can have your users and groups from Google Workspace and assign them permissions. Essentially what it boils down to is the employees from the company that you're acquiring need to get onto your Google Workspace. That part should be pretty obvious hopefully, but this isn't as hard of a prerequisite as it would be for AM identity center. You can enable crossdmain sharing in GCP and assign permissions to the uh identities the users and groups from the Google workspace of the company that you've acquired. Um there's also a fun another fun slight complication with workspace which is to completely delete a GCP organization you have to delete the underlying Google Workspace account. Google describes this as potentially a very damaging action that might be impossible to fully reverse. This has implications far far beyond just your cloud environment, especially if the company you're acquiring is using say corporate Gmail. Um, this will have to be a discussion with whichever team at your company handles email identity management. Make sure you know what you're doing if you decide to do this. The last GCP specific topic that I want to talk about is the VPC service control perimeter. This is a fairly advanced uh feature in GCP. You can think of it kind of like a firewall for the GCP API in the projects that it protects. Um basically making it so that requests to the GCP API have to come from either within the VPC or within certain IP addresses. uh you have to disable this to migrate projects uh between organizations. You cannot migrate a project that is protected by a VPC service control security perimeter. And if you have the option to do this to just disable it for a while, that's fine. But if you're using this, for example, to satisfy a compliance requirement, you might not be able to do that. And if that's the case, I actually don't have a good answer for you other than to contact support. Um, quite frankly, if you've done one of these migrations and have had to navigate this, I would like to hear from you. This one wasn't something that I uh dealt with directly, but it was more of an observation from careful reading of the documentation. But now we're going to look beyond the cloud providers. There are, as you might imagine, a lot of things within your company that ultimately impact the cloud environment that aren't necessarily part of it. I'm going to start with log management. Um, your company might be using a different SIM or the company you're requiring may not be using one at all. There are a lot of different options for this. You could have open search, Splunk, thirdparty tools, SAS solutions. I'm going to try to keep this as generally applicable as possible because there are a lot of intricacies to any of those things. But if you have any infrastructure in your cloud environment that's handling the cloud logs. So cloud trail and cloudatch in AWS cloud logging in GCP for example you need to make sure that it's going to start including the logs from the AWS accounts GCP projects etc that you're acquiring. And if it doesn't pull them in automatically make sure that that infrastructure is getting deployed as needed. Uh, if the company that you're acquiring has their own SIM already, you'll also need to make sure that whatever they're using to get their logs doesn't break during the migration and that you can maintain that until you can decommission their SIM. And above all else, make sure that you're not losing logs during the migration. The last thing that I'm going to talk about is something that I call the web of dependencies. Um, basically you're not just acquiring this company's cloud environment. You're acquiring the whole thing. There are a bunch of different things that are interconnected that um that are going to be other factors that will impact your cloud environment and maybe in ways that you don't immediately expect. think your SSO provider, whatever CI/CD pipeline you're using, whoever is responsible for infrastructure, network infrastructure, the stakeholders for all of these things are going to need to be involved in this migration effort. Um, if you're a big enough company, those could all be totally separate teams. And on the other hand, if you're a small enough company, most of those things could be the same person. Uh to say nothing of having to get teams like finance and billing involved um along with the count with their counterparts from the company that you're acquiring. So short version is make sure everything gets prioritized appropriately. Make sure that things get done in the right order so that nothing breaks. Have a migration plan. document it well and also perhaps equally importantly have a backout plan for each step. This is another thing that Google is explicit about in their documentation. But if you're for example moving a GCP project from the source or into your org, make sure that you have the permissions set up so that you can send it back if something goes wrong in the way that you don't expect. be able to undo anything that you do with this. Um, so TLDDR, read the documentation, read it carefully, pay extra close attention to your organization level services. Um, understand how your company and the company that you're acquiring are using them. Have a mig migration plan. Document it well. Get all of the stakeholders involved as early as possible. And when in doubt, contact support. I cannot stress that enough. If you are at all unsure about something, reach out to support. They will help you through it. Obligatory attribution slide because seriously, I lifted kind of a lot of this from the documentation. And yeah, that's it. That's the talk. My first question is uh and this is for me. Your face looks like shell shocked soldiers coming back from World War II as you were delivering the last part of that. And how much therapy did you have to have after going through this? Just a little bit. No. Uh, honestly, it's not even that it was traumatic. It's just, you know, I don't know how I want to put this, but uh, I don't know. I learned a lot going through them and I felt like I did better each time I went through another acquisition. Um it I wish I didn't have to do all of it like like learn on the job and like learn through experience, but um I guess that's why I'm telling everyone else about this. All right, we did not have any questions in the room. Any questions in this room? Thank you so much. I just um had a question about um AWS specifically. So if um both your source organization and your like destination organization have like separate delegated admins for let's let's choose another service like security hub and you wanted to migrate some of those like child accounts. Do you have to like dregister them from the source like manage security hub migrate and then like uh re-manage them or how does that work? So for the member accounts and if assuming you're using delegated admin and this isn't a service that's like guard duty where you can do it multiple ways. Uh I believe that it will just kind of work automatically. You don't have to manually dregister anything on the member accounts. Um that was more specific to guard duty. Did you have any AM policies with source or ID and did you have to go through and deal with those manually? Yes. And that's another thing that got cut for time. Um, quite frankly, I think that AWS's own documentation around that is actually uh pretty thorough. Did you step into the landmine that is uh um resource access manager and shared VPCs and shared uh uh route 53 and all of that? I didn't personally, but uh in the process of putting together this talk, I was talking to someone else who had gone through something similar and uh mentioned that it was exactly as bad as you described. Any other questions? All right. Well, thank you very much and uh it was awesome.
